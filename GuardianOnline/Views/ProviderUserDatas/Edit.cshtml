@model GuardianOnline.Infrastructure.ProviderUserData

@{
    ViewBag.Title = "Edit";
    Layout = "~/Views/Shared/_LayoutV2.cshtml";

    Func<string, string, string> T = (key, fallback) =>
    {
        try
        {
            var o = HttpContext.GetGlobalResourceObject("ProviderUsers", key);
            return (o == null) ? fallback : o.ToString();
        }
        catch { return fallback; }
    };
}

<div class="pv-page">
    <div class="pv-shell">

        <!-- Header -->
        <div class="pv-header">
            <div>
                <div class="pv-title">@T("Edit_Title", "Edit User Data")</div>
                <div class="pv-sub">@T("Edit_SubTitle", "Update provider user information")</div>
            </div>

            <div class="pv-actions">
                <a class="btn btn-outline-secondary pv-btn" href="@Url.Action("Index","ProviderUserDatas")">
                    <i class="bi bi-arrow-left"></i>
                    <span>@T("Btn_BackList", "Back to Main List")</span>
                </a>
            </div>
        </div>

        @Scripts.Render("~/bundles/jquery")
        @Scripts.Render("~/bundles/bootstrap")
        <script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
        <script src="~/signalr/hubs" type="text/javascript"></script>

        <link rel="stylesheet" href="~/Content/select2.min.css">
        <script type="text/javascript" src="~/Scripts/select2.min.js"></script>
        <script type="text/javascript" src="~/Scripts/moment-with-locales.min.js"></script>

        @Html.Hidden("Get", Url.Action("Get", "Customer"))
        @Html.Hidden("Getmessages", Url.Action("Getmessages", "Customer"))
        @Html.Hidden("Get1", Url.Action("Get1", "Customer"))

        <input type="hidden" id="trigger" value="0" />
        <input type="hidden" id="triggercount" value="0" />
        <input type="hidden" id="trigger1" value="0" />
        <input type="hidden" id="triggercount1" value="0" />

        <div class="pv-card">
            <div class="pv-card-head">
                <div class="pv-card-title">@T("UserData_Legend", "User Data")</div>
            </div>

            @using (Html.BeginForm("Edit", "ProviderUserDatas", FormMethod.Post, new { enctype = "multipart/form-data" }))
            {
                @Html.AntiForgeryToken()

                <div class="pv-form">
                    @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                    @Html.HiddenFor(model => model.UserID)
                    @Html.HiddenFor(model => model.ProviderID)

                    <div class="pv-row">
                        <div class="pv-col-label">
                            @Html.LabelFor(model => model.BranchID, htmlAttributes: new { @class = "pv-label", @id = "branch_Nameslabel" })
                        </div>
                        <div class="pv-col-input">
                            @{ string a = ViewBag.q; }
                            @Html.DropDownList("sda", new SelectList(ViewBag.branchNames, a), htmlAttributes: new { @class = "form-control pv-control", @id = "branch_Names", @Name = "branch_Names" })
                            @Html.ValidationMessageFor(model => model.BranchID, "", new { @class = "text-danger" })
                        </div>
                    </div>

                    <div class="pv-row">
                        <div class="pv-col-label">
                            @Html.LabelFor(model => model.UserName, htmlAttributes: new { @class = "pv-label", @id = "User_Namelabel" })
                        </div>
                        <div class="pv-col-input">
                            @Html.EditorFor(model => model.UserName, new { htmlAttributes = new { @class = "form-control pv-control", @id = "User_Name" } })
                            @Html.ValidationMessageFor(model => model.UserName, "", new { @class = "text-danger" })
                        </div>
                    </div>

                    <div class="pv-row">
                        <div class="pv-col-label">
                            @Html.LabelFor(model => model.FirstName, htmlAttributes: new { @class = "pv-label", @id = "First_Namelabel" })
                        </div>
                        <div class="pv-col-input">
                            @Html.EditorFor(model => model.FirstName, new { htmlAttributes = new { @class = "form-control pv-control", @id = "First_Name" } })
                            @Html.ValidationMessageFor(model => model.FirstName, "", new { @class = "text-danger" })
                        </div>
                    </div>

                    <div class="pv-row">
                        <div class="pv-col-label">
                            @Html.LabelFor(model => model.LastName, htmlAttributes: new { @class = "pv-label", @id = "Last_Namelabel" })
                        </div>
                        <div class="pv-col-input">
                            @Html.EditorFor(model => model.LastName, new { htmlAttributes = new { @class = "form-control pv-control", @id = "Last_Name" } })
                            @Html.ValidationMessageFor(model => model.LastName, "", new { @class = "text-danger" })
                        </div>
                    </div>

                    <div class="pv-row">
                        <div class="pv-col-label">
                            @Html.LabelFor(model => model.UserEmail, htmlAttributes: new { @class = "pv-label", @id = "User_Emaillabel" })
                        </div>
                        <div class="pv-col-input">
                            @Html.EditorFor(model => model.UserEmail, new { htmlAttributes = new { @class = "form-control pv-control", @id = "User_Email" } })
                            @Html.ValidationMessageFor(model => model.UserEmail, "", new { @class = "text-danger" })
                        </div>
                    </div>

                    <div class="pv-row" hidden>
                        <div class="pv-col-label">
                            @Html.LabelFor(model => model.UserPassword, htmlAttributes: new { @class = "pv-label", @id = "User_Passwordlabel" })
                        </div>
                        <div class="pv-col-input">
                            @Html.EditorFor(model => model.UserPassword, new { htmlAttributes = new { @class = "form-control pv-control", @id = "User_Password", @Value = "Mmmmmmm@30888" } })
                            @Html.ValidationMessageFor(model => model.UserPassword, "", new { @class = "text-danger" })
                        </div>
                    </div>

                    <div class="pv-row" hidden>
                        <div class="pv-col-label">
                            @Html.LabelFor(model => model.confUserPassword, htmlAttributes: new { @class = "pv-label", @id = "confUser_Passwordlabel" })
                        </div>
                        <div class="pv-col-input">
                            @Html.EditorFor(model => model.confUserPassword, new { htmlAttributes = new { @class = "form-control pv-control", @Value = "Mmmmmmm@30888", @id = "confUser_Password" } })
                            @Html.ValidationMessageFor(model => model.confUserPassword, "", new { @class = "text-danger" })
                        </div>
                    </div>

                    <div class="pv-row">
                        <div class="pv-col-label">
                            @Html.LabelFor(model => model.IsLockedOut, htmlAttributes: new { @class = "pv-label", @id = "IsLockedOutlabel" })
                        </div>
                        <div class="pv-col-input pv-check">
                            <div class="checkbox">
                                @Html.EditorFor(model => model.IsLockedOut)
                                @Html.ValidationMessageFor(model => model.IsLockedOut, "", new { @class = "text-danger" })
                            </div>
                        </div>
                    </div>

                    <div class="pv-row">
                        <div class="pv-col-label">
                            <label class="pv-label" id="imgfilelabel">@T("UserImage", "User Image")</label>
                        </div>
                        <div class="pv-col-input">
                            <input type="file" id="imgfile" name="imgfile" class="form-control pv-control" />
                            @Html.ValidationMessageFor(model => model.UserImage, "", new { @class = "text-danger" })
                        </div>
                    </div>

                    <div class="pv-row" hidden>
                        <div class="pv-col-label">
                            @Html.LabelFor(model => model.IsAdmin, htmlAttributes: new { @class = "pv-label" })
                        </div>
                        <div class="pv-col-input">
                            <div class="checkbox">
                                @Html.EditorFor(model => model.IsAdmin)
                                @Html.ValidationMessageFor(model => model.IsAdmin, "", new { @class = "text-danger" })
                            </div>
                        </div>
                    </div>

                    <div class="pv-row" hidden>
                        <div class="pv-col-label">
                            @Html.LabelFor(model => model.ProviderAdmin, htmlAttributes: new { @class = "pv-label" })
                        </div>
                        <div class="pv-col-input">
                            <div class="checkbox">
                                @Html.EditorFor(model => model.ProviderAdmin)
                                @Html.ValidationMessageFor(model => model.ProviderAdmin, "", new { @class = "text-danger" })
                            </div>
                        </div>
                    </div>

                    <div class="pv-actions-bottom">
                        <input type="submit" value="@T("Btn_Save","Save")" class="btn btn-success btn-lg pv-save" />
                        <a class="btn btn-outline-secondary pv-btn" href="@Url.Action("Index","ProviderUserDatas")">
                            <i class="bi bi-arrow-left"></i>
                            <span>@T("Btn_BackList", "Back to Main List")</span>
                        </a>
                    </div>
                </div>
            }
        </div>

        @if (ViewBag.ErorMessage != null || ViewBag.branchNameselect != null)
        {
            <script type="text/javascript">
                window.onload = function () {
                    Swal.fire("Error !", "@ViewBag.ErorMessage", "error");
                    $('#branch_Names').val("@ViewBag.branchNameselect").change();
                };
            </script>
        }

        <!-- ===== ORIGINAL SCRIPTS (UNCHANGED) ===== -->
        <script type="text/javascript">
            $(document).ready(function () {


                $("#provider_names").select2();
                $("#branch_Names").select2();

                $("#provider_names").change(function () {

                    $.get("/UserDatas/Get_Provider_Branch", { id: $('#provider_names').val() }, function (data) {
                        $('#branch_Names')
                            .find('option')
                            .remove()
                            .end()
                            .append('<option value="whatever">Select Provider Branch</option>')
                            .val('whatever')
                            ;
                        var select = document.getElementById("branch_Names"), data;


                        for (var i = 0; i < data.length; i++) {
                            var opt = document.createElement("option");


                            txt = document.createTextNode(data[i]);
                            opt.appendChild(txt);
                            opt.setAttribute("value", data[i]);
                            select.insertBefore(opt, select.lastChild);

                        }




                    })



                });


            });

        </script>
        <script type="text/javascript">
            $(document).on('select2:open', () => {
                document.querySelector('.select2-search__field').focus();
            });
        </script>

        <script type="text/javascript">
            document.addEventListener("visibilitychange", () => {
                if (document.hidden) {
                    $.connection.hub.stop();
                } else {
                    $.connection.hub.start().done(function () {
                        getData();
                        getData1();
                    }).fail(function (e) {
                    });
                }
            });

            function sleep(ms) {
                return new Promise(
                    resolve => setTimeout(resolve, ms)
                );


            }
            $(function () {
                var cus = $.connection.cusHub;

                cus.client.displayCustomer = function () { getData(); };
                cus.client.data = function () { getData1(); };

                cus.client.data1 = function () {
                    getData2();
                };
                $.connection.hub.start();
                getData();
                getData1();
                getData2();
            });
            function getData1() {
                try {

                    $.ajax({
                        url: $("#Getmessages").val(),
                        type: 'GET',
                        datatype: 'json',
                        success: function (data1) {

                            $.get("/ClaimForm/getcountmessage", {}, function (data) {
                                setBadgeCount('MesaageCount', data);
                            });


                            $.each(data1.listCus, function (i, model) {

                            });
                        }
                    });
                }
                catch (err) {
                }
            }

            function getData() { /* as-is elsewhere */ }
            function getData2() { /* as-is elsewhere */ }
        </script>

        <script>
            function refresh() {

                $.ajax({
                    type: "POST",
                    url: "/ClaimForm/CheckIfSessionValid",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (r) {
                        if (r == "False") {
                            window.open('@Url.Action("login", "ClaimForm")', '_self');
                        }
                        else {
                            setTimeout(refresh, 5000);
                        }
                    }
                });

            }

            setTimeout(refresh, 1000);
        </script>

    </div>
</div>