@model IEnumerable<GuardianOnline.Infrastructure.ProviderUserData>

@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_LayoutV2.cshtml";

    Func<string, string, string> T = (key, fallback) =>
    {
        try
        {
            var o = HttpContext.GetGlobalResourceObject("ProviderUsers", key);
            return (o == null) ? fallback : o.ToString();
        }
        catch { return fallback; }
    };
}

<div class="pv-page">
    <div class="pv-shell">

        <!-- Header -->
        <div class="pv-header">
            <div>
                <div class="pv-title">@T("Users_Title", "Users")</div>
                <div class="pv-sub">@T("Users_SubTitle", "Manage provider users")</div>
            </div>

            <div class="pv-actions">
                <a class="btn btn-outline-secondary pv-btn" href="@Url.Action("DoctorHome","ClaimForm")">
                    <i class="bi bi-arrow-left"></i>
                    <span>@T("Btn_BackHome", "Back to Home")</span>
                </a>

                <a class="btn btn-primary pv-btn" href="@Url.Action("Create","ProviderUserDatas")">
                    <i class="bi bi-plus-circle"></i>
                    <span>@T("Btn_AddUser", "Add User")</span>
                </a>
            </div>
        </div>

        <!-- ✅ IMPORTANT: jQuery لازم -->
        @Scripts.Render("~/bundles/jquery")
        @Scripts.Render("~/bundles/bootstrap")
        <script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
        <script src="~/signalr/hubs" type="text/javascript"></script>

        <link rel="stylesheet" href="~/Content/select2.min.css">
        <script type="text/javascript" src="~/Scripts/select2.min.js"></script>
        <script type="text/javascript" src="~/Scripts/moment-with-locales.min.js"></script>

        @Html.Hidden("Get", Url.Action("Get", "Customer"))
        @Html.Hidden("Getmessages", Url.Action("Getmessages", "Customer"))
        @Html.Hidden("Get1", Url.Action("Get1", "Customer"))

        <input type="hidden" id="trigger" value="0" />
        <input type="hidden" id="triggercount" value="0" />
        <input type="hidden" id="trigger1" value="0" />
        <input type="hidden" id="triggercount1" value="0" />

        <!-- ✅ محتوى الصفحة -->
        <div class="pv-card">
            <div class="pv-card-head">
                <div class="pv-card-title">@T("Users_Legend", "Users Data")</div>

                <a href="@Url.Action("Create","ProviderUserDatas")" class="btn btn-primary pv-btn">
                    <i class="bi bi-plus-circle"></i>
                    <span>@T("Btn_AddUser", "Add User")</span>
                </a>
            </div>

            <div class="pv-toolbar">
                <div class="pv-toolbar-row">
                    <label class="pv-label" for="User_list">@T("Users_List", "Users list")</label>
                    @Html.DropDownList("Citydropdown1",
                        new SelectList(ViewBag.li),
                        T("SelectUser", "----Select User Name----"),
                        htmlAttributes: new { @class = "form-control", @id = "User_list", @Name = "User_list" })
                </div>
            </div>

            <div class="table-responsive pv-table-wrap">
                <table class="table table-sm table-bordered align-middle mb-0" id="tblusers" cellpadding="0" cellspacing="0">
                    <thead>
                        <tr>
                            <th>@T("Col_UserName", "User Name")</th>
                            <th>@T("Col_Email", "Email")</th>
                            <th>@T("Col_Password", "Password")</th>
                            <th>@T("Col_CreateDate", "Create Date")</th>
                            <th>@T("Col_FirstName", "First Name")</th>
                            <th>@T("Col_LastName", "Last Name")</th>
                            <th>@T("Col_Locked", "Locked")</th>
                            <th style="min-width:140px;">@T("Col_Actions", "Actions")</th>
                        </tr>
                    </thead>
                    <tbody>
                        @* الجدول بيتعبى بالـ script زي ما هو *@
                    </tbody>
                </table>
            </div>

            <div class="pv-footer">
                <a class="btn btn-outline-secondary pv-btn" href="@Url.Action("DoctorHome","ClaimForm")">
                    <i class="bi bi-arrow-left"></i>
                    <span>@T("Btn_BackHome", "Back to Home")</span>
                </a>
            </div>
        </div>

        <!-- =======================
             ✅ Scripts ORIGINAL (بدون أي تعديل)
             ======================= -->

        <script type="text/javascript">
            $(document).ready(function () {
                $("#tblusers").hide();

                $("#User_list").select2();

                $("#User_list").change(function () {

                    $.get("/UserDatas/Select_User", { id: $('#User_list').val() }, function (data) {
                        $("#tblusers").hide();
                        if (data != "") {
                            $("#tblusers").show();
                            $("#tblusers").find("tr:not(:first)").remove();
                            var tBody = $("#tblusers > TBODY")[0];

                            for (var i = 0; i < data.length; i++) {

                                var row = tBody.insertRow(-1);

                                var cell = $(row.insertCell(-1));
                                cell.html(data[i].UserName);

                                cell = $(row.insertCell(-1));
                                cell.html(data[i].UserEmail);

                                cell = $(row.insertCell(-1));
                                cell.html(data[i].UserPassword);

                                var StartDate = moment(data[i].CreateDate);

                                cell = $(row.insertCell(-1));
                                cell.html(StartDate.format("DD-MM-YYYY"));

                                cell = $(row.insertCell(-1));
                                cell.html(data[i].FirstName);

                                cell = $(row.insertCell(-1));
                                cell.html(data[i].LastName);

                                cell = $(row.insertCell(-1));
                                var checkbox1 = $("<input />");
                                checkbox1.attr("type", "checkbox");
                                checkbox1.attr("id", "IsACTIVE1");

                                checkbox1.attr("Active");
                                checkbox1.val("Active");
                                cell.append(checkbox1);

                                if (data[i].IsLockedOut != false) {
                                    $("#IsACTIVE1").prop('checked', true);
                                }
                                else {
                                    $('#IsACTIVE1').prop('checked', false);
                                }

                                cell = $(row.insertCell(-1));
                                var btnEdit = $("<input />");
                                btnEdit.attr("type", "button");
                                btnEdit.attr("id", "1");
                                btnEdit.attr("class", "btn btn-success");
                                btnEdit.attr("onclick", "location.href='../ProviderUserDatas/edit/" + data[i].UserID + "'");
                                btnEdit.attr("Edit");
                                btnEdit.val("Edit");
                                cell.append(btnEdit);
                            }
                        }

                    })

                });
            });

        </script>
        <script type="text/javascript">
            $(document).on('select2:open', () => {
                document.querySelector('.select2-search__field').focus();
            });
        </script>


        <script type="text/javascript">
            document.addEventListener("visibilitychange", () => {
                if (document.hidden) {
                    $.connection.hub.stop();
                } else {
                    $.connection.hub.start().done(function () {
                        getData();
                        getData1();
                    }).fail(function (e) {
                    });
                }
            });

            function sleep(ms) {
                return new Promise(
                    resolve => setTimeout(resolve, ms)
                );
            }
            $(function () {

                var cus = $.connection.cusHub;

                cus.client.displayCustomer = function () { getData(); };
                cus.client.data = function () { getData1(); };
                cus.client.data1 = function () { getData2(); };

                $.connection.hub.start();
                getData();
                getData1();
                getData2();
            });

            function getData1() {
                try {

                    $.ajax({
                        url: $("#Getmessages").val(),
                        type: 'GET',
                        datatype: 'json',
                        success: function (data1) {

                            $.get("/ClaimForm/getcountmessage", {}, function (data) {
                                if (data == 0) {
                                    $('#MesaageCount').removeAttr("data-count");
                                }
                                else {
                                    $('#MesaageCount').attr("data-count", data);
                                }
                            });

                            $.each(data1.listCus, function (i, model) { });
                        }
                    });
                }
                catch (err) { }
            }

            function getData() { /* موجود عندك في layout/صفحات تانية */ }
            function getData2() { /* موجود عندك في layout/صفحات تانية */ }
        </script>

        <script>
            function refresh() {

                $.ajax({
                    type: "POST",
                    url: "/ClaimForm/CheckIfSessionValid",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (r) {
                        if (r == "False") {
                            window.open('@Url.Action("login", "ClaimForm")', '_self');
                        }
                        else {
                            setTimeout(refresh, 5000);
                        }
                    }
                });

            }

            setTimeout(refresh, 1000);
        </script>

    </div>
</div>