@{
    ViewBag.Title = "Invoices_Audit";
    Layout = "~/Views/Shared/_LayoutV2.cshtml";

    Func<string, string, string> T = (key, fallback) =>
    {
        try
        {
            var o = HttpContext.GetGlobalResourceObject("InvoicesAudit", key);
            return (o == null) ? fallback : o.ToString();
        }
        catch { return fallback; }
    };
}

@* ✅ لازم jQuery قبل أي plugin *@
@Scripts.Render("~/bundles/jquery")

@* (زي صفحاتك القديمة) *@
@Scripts.Render("~/bundles/bootstrap")
<script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
<script src="~/signalr/hubs" type="text/javascript"></script>

@* ===== DataTables Core (لازم) ===== *@
<link rel="stylesheet" href="~/Content/jquery.dataTables.min.css" />
<script type="text/javascript" src="~/Scripts/jquery.dataTables.min.js"></script>

@* Bootstrap5 integration (شكل أحسن) *@
<link rel="stylesheet" href="~/Content/dataTables.bootstrap5.min.css" />
<script type="text/javascript" src="~/Scripts/dataTables.bootstrap5.min.js"></script>

@* ===== DataTables Buttons ===== *@
<link rel="stylesheet" href="~/Content/buttons.dataTables.min.css">
<script type="text/javascript" src="~/Scripts/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="~/Scripts/jszip.min.js"></script>
<script type="text/javascript" src="~/Scripts/buttons.html5.min.js"></script>
<script type="text/javascript" src="~/Scripts/buttons.print.min.js"></script>

@* Date sorting plugin *@
<script type="text/javascript" src="~/Scripts/date-eu.js"></script>

@Html.Hidden("Get", Url.Action("Get", "Customer"))
@Html.Hidden("Getmessages", Url.Action("Getmessages", "Customer"))
@Html.Hidden("Get1", Url.Action("Get1", "Customer"))

<input type="hidden" id="trigger" value="0" />
<input type="hidden" id="triggercount" value="0" />
<input type="hidden" id="trigger1" value="0" />
<input type="hidden" id="triggercount1" value="0" />

<style>
    /* ===== Page wrapper (V2 consistent) ===== */
    .ex-page .pv-shell {
        max-width: 1280px;
        margin: 0 auto;
    }

    .ex-page .pv-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
        margin: 8px 0 12px;
    }

    .ex-page .pv-title {
        font-size: 22px;
        font-weight: 900;
        color: #0b2b40;
    }

    .ex-page .pv-sub {
        font-size: 13px;
        font-weight: 700;
        color: rgba(15,23,42,.65);
        margin-top: 4px;
    }

    .ex-page .pv-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .ex-page .pv-btn {
        border-radius: 14px;
        font-weight: 900;
        padding: 10px 14px;
        display: inline-flex;
        gap: 10px;
        align-items: center;
    }

    .ex-page .pv-card {
        background: #fff;
        border: 1px solid rgba(0,0,0,.08);
        border-radius: 18px;
        box-shadow: 0 12px 30px rgba(15,23,42,.06);
        padding: 14px;
    }

    .ex-page .pv-card-title {
        font-size: 16px;
        font-weight: 900;
        color: #0b2b40;
        margin-bottom: 10px;
    }

    /* ===== Summary Cards ===== */
    .ex-sum {
        display: grid;
        grid-template-columns: repeat(4, minmax(170px, 1fr));
        gap: 12px;
        margin-bottom: 12px;
    }

    @@media (max-width: 992px) {
        .ex-sum {
            grid-template-columns: 1fr;
        }
    }

    .ex-scard {
        background: #fff;
        border: 1px solid rgba(0,0,0,.08);
        border-radius: 16px;
        box-shadow: 0 10px 26px rgba(15,23,42,.06);
        padding: 12px 14px;
        display: flex;
        gap: 12px;
        align-items: center;
        min-height: 74px;
    }

    .ex-sicon {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(24,169,153,.12);
        border: 1px solid rgba(24,169,153,.22);
        color: #0b2b40;
        font-size: 20px;
        flex: 0 0 auto;
    }

    .ex-slabel {
        font-size: 12px;
        font-weight: 900;
        color: rgba(15,23,42,.65);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .ex-svalue {
        font-size: 18px;
        font-weight: 900;
        color: #0b2b40;
        direction: ltr;
        text-align: start;
    }

    /* ===== Controls ===== */
    .ex-controls {
        display: grid;
        grid-template-columns: 1.2fr 1.5fr 1.3fr;
        gap: 12px;
        align-items: end;
        margin-bottom: 10px;
    }

    @@media (max-width: 992px) {
        .ex-controls {
            grid-template-columns: 1fr;
        }
    }

    .ex-search {
        position: relative;
    }

        .ex-search i {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            left: 12px;
            color: rgba(15,23,42,.55);
        }

    html[dir="rtl"] .ex-search i {
        left: auto;
        right: 12px;
    }

    .ex-search input {
        padding-left: 38px;
        min-height: 44px;
        border-radius: 14px;
    }

    html[dir="rtl"] .ex-search input {
        padding-left: 12px;
        padding-right: 38px;
    }

    .ex-select select {
        min-height: 44px;
        border-radius: 14px;
        font-weight: 800;
    }

    .ex-dates {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
    }

        .ex-dates label {
            font-size: 13px;
            font-weight: 900;
            color: rgba(15,23,42,.65);
        }

        .ex-dates input {
            min-height: 44px;
            border-radius: 14px;
        }

    /* ===== Table wrapper / scroll ===== */
    .ex-table-wrap {
        overflow: auto;
        border-radius: 14px;
        border: 1px solid rgba(0,0,0,.08);
    }

        .ex-table-wrap table {
            min-width: 1200px;
        }

    .ex-page table.dataTable thead th {
        background: rgba(24,169,153,.12) !important;
        border-bottom: 1px solid rgba(24,169,153,.22) !important;
        color: #0b2b40 !important;
        font-weight: 900 !important;
        font-size: 13px !important;
        white-space: nowrap;
        vertical-align: middle;
        text-align: center;
    }

    .ex-page table.dataTable td {
        font-size: 13px;
        white-space: nowrap;
        vertical-align: middle;
        text-align: center;
    }

    .ex-actions-row {
        display: flex;
        justify-content: center;
        gap: 12px;
        flex-wrap: wrap;
        margin: 12px 0;
    }

        .ex-actions-row .btn {
            border-radius: 14px;
            padding: 10px 18px;
            font-weight: 900;
        }

    /* ===== Checkbox wrapper (reuse same) ===== */
    .checkbox-wrapper-19 {
        box-sizing: border-box;
        --background-color: #fff;
        --checkbox-height: 25px;
    }

        .checkbox-wrapper-19 input[type=checkbox] {
            display: none;
        }

        .checkbox-wrapper-19 .check-box {
            height: var(--checkbox-height);
            width: var(--checkbox-height);
            background-color: transparent;
            border: calc(var(--checkbox-height)*.1) solid #000;
            border-radius: 5px;
            position: relative;
            display: inline-block;
            box-sizing: border-box;
            transition: border-color .2s ease;
            cursor: pointer;
        }

            .checkbox-wrapper-19 .check-box::before, .checkbox-wrapper-19 .check-box::after {
                box-sizing: border-box;
                position: absolute;
                height: 0;
                width: calc(var(--checkbox-height)*.2);
                background-color: #34b93d;
                display: inline-block;
                transform-origin: left top;
                border-radius: 5px;
                content: " ";
            }

            .checkbox-wrapper-19 .check-box::before {
                top: calc(var(--checkbox-height)*.72);
                left: calc(var(--checkbox-height)*.41);
                box-shadow: 0 0 0 calc(var(--checkbox-height)*.05) var(--background-color);
                transform: rotate(-135deg);
            }

            .checkbox-wrapper-19 .check-box::after {
                top: calc(var(--checkbox-height)*.37);
                left: calc(var(--checkbox-height)*.05);
                transform: rotate(-45deg);
            }

        .checkbox-wrapper-19 input[type=checkbox]:checked + .check-box {
            border-color: #34b93d;
        }

            .checkbox-wrapper-19 input[type=checkbox]:checked + .check-box::after {
                height: calc(var(--checkbox-height)/2);
            }

            .checkbox-wrapper-19 input[type=checkbox]:checked + .check-box::before {
                height: calc(var(--checkbox-height)*1.2);
            }

    /* details-control icons */
    td.details-control {
        background: url('/Images/details_open.png') no-repeat center center;
        cursor: pointer;
    }

    tr.shown td.details-control {
        background: url('/Images/details_close.png') no-repeat center center;
        cursor: pointer;
    }

    /* Loading overlay */
    #backring1 {
        background-color: rgba(0,0,0,.25);
        display: none;
    }

    .ring1 {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%,-50%);
        width: 150px;
        height: 150px;
        border: 3px solid #9ac3b8;
        border-radius: 50%;
        text-align: center;
        line-height: 150px;
        font-size: 20px;
        letter-spacing: 2px;
        color: #fff000;
        text-transform: uppercase;
        text-shadow: 0 0 10px #fff000;
        background-color: #11395c;
        box-shadow: 0 0 20px rgba(0,0,0,.35);
    }

        .ring1:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 3px solid transparent;
            border-top: 3px solid #fff000;
            border-right: 3px solid #fff000;
            box-shadow: 0 0 1em white, 0 0 0 1000vw rgba(224,222,222,.70);
            border-radius: 50%;
            animation: animateC1 2s linear infinite;
        }

    spana1 {
        display: block;
        position: absolute;
        top: calc(50% - 2px);
        left: 50%;
        width: 50%;
        height: 4px;
        background: transparent;
        transform-origin: left;
        animation: animate1 2s linear infinite;
    }

        spana1:before {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #fff000;
            top: -6px;
            right: -8px;
            box-shadow: 0 0 20px #fff000;
        }

    @@keyframes animateC1 {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    @@keyframes animate1 {
        0% {
            transform: rotate(45deg);
        }

        100% {
            transform: rotate(405deg);
        }
    }
</style>

<div class="ex-page">
    <div class="pv-shell">

        <div class="pv-header">
            <div>
                <div class="pv-title">@T("Title", "Invoices Audit")</div>
                <div class="pv-sub">@T("SubTitle", "Review invoices, edit requested amount, then send to Accounting")</div>
            </div>

            <div class="pv-actions">
                <a class="btn btn-outline-secondary pv-btn" href="@Url.Action("DoctorHome","ClaimForm")">
                    <i class="bi bi-arrow-left"></i>
                    <span>@T("BackHome", "Back to Main Home")</span>
                </a>

                <a class="btn btn-outline-primary pv-btn" href="@Url.Action("Provider_Expended_services","ClaimForm")">
                    <i class="bi bi-receipt"></i>
                    <span>@T("GoExpended", "Go to Expended services")</span>
                </a>
            </div>
        </div>

        <div class="pv-card">
            <div class="pv-card-title">@T("CardTitle", "Invoices Audit Content")</div>

            @* ===== Summary cards (JS will fill) ===== *@
            <div class="ex-sum">
                <div class="ex-scard">
                    <div class="ex-sicon"><i class="bi bi-list-check"></i></div>
                    <div>
                        <div class="ex-slabel">@T("Sum_TotalInvoices", "Total Invoices")</div>
                        <div class="ex-svalue" id="sumTotalRows">0</div>
                    </div>
                </div>

                <div class="ex-scard">
                    <div class="ex-sicon"><i class="bi bi-check2-square"></i></div>
                    <div>
                        <div class="ex-slabel">@T("Sum_SelectedCount", "Selected Count")</div>
                        <div class="ex-svalue" id="sumSelectedCount">0</div>
                    </div>
                </div>

                <div class="ex-scard">
                    <div class="ex-sicon"><i class="bi bi-cash-stack"></i></div>
                    <div>
                        <div class="ex-slabel">@T("Sum_SelectedRequested", "Selected Requested")</div>
                        <div class="ex-svalue" id="sumSelectedRequested">0.00</div>
                    </div>
                </div>

                <div class="ex-scard">
                    <div class="ex-sicon"><i class="bi bi-arrow-left-right"></i></div>
                    <div>
                        <div class="ex-slabel">@T("Sum_SelectedDifference", "Selected Difference")</div>
                        <div class="ex-svalue" id="sumSelectedDiff">0.00</div>
                    </div>
                </div>
            </div>

            @* ===== Controls ===== *@
            <div class="ex-controls">
                <div class="ex-search">
                    <i class="bi bi-search"></i>
                    <input id="exSearch" type="text" class="form-control" placeholder="@T("Search","Search...")" />
                </div>

                <div class="ex-select">
                    <select id="exBranch" class="form-select">
                        <option value="">@T("Branch_All", "All Branches")</option>
                    </select>
                </div>

                <div class="ex-dates">
                    <div>
                        <label>@T("FromDate", "From Date")</label>
                        <input type="date" id="fromDate" class="form-control" onchange="selectDate()" />
                    </div>
                    <div>
                        <label>@T("ToDate", "To Date")</label>
                        <input type="date" id="toDate" class="form-control" onchange="selectDate()" />
                    </div>
                </div>
            </div>

            <div class="ex-actions-row">
                <button type="button" id="Send_To_Pay" class="btn btn-primary btn-lg">
                    <span class="glyphicon glyphicon-send"></span>&nbsp; @T("SendToPay", "Send To Pay")
                </button>
            </div>

            <div class="ex-table-wrap">
                <table class="table table-hover align-middle mb-0" id="tblApprovals" cellpadding="0" cellspacing="0">
                    <thead>
                        <tr>
                            <th></th>
                            <th>@T("Col_ClaimID", "Claim ID")</th>
                            <th>@T("Col_ClaimFormNum", "ClaimForm Number")</th>
                            <th>@T("Col_CardNumber", "Card Number")</th>
                            <th>@T("Col_ProcedureDate", "Procedure Date")</th>
                            <th>@T("Col_ContractAmt", "Contract Amt")</th>
                            <th>@T("Col_DeductAmt", "Deductable Amt")</th>
                            <th>@T("Col_DiscountAmt", "Discount Amt")</th>
                            <th>@T("Col_DueAmt", "Due Amt")</th>
                            <th>@T("Col_RequestedAmt", "Requested Amt")</th>
                            <th>@T("Col_DifferenceAmt", "Difference Amt")</th>
                            <th>@T("Col_BranchName", "Branch Name")</th>
                            <th>
                                <div class="checkbox-wrapper-19">
                                    <input type="checkbox" id="select_all">
                                    <label style="background-color:white" for="select_all" class="check-box"></label>
                                </div>
                            </th>
                        </tr>
                    </thead>
                </table>
            </div>

            <div class="pv-actions" style="justify-content:space-between; margin-top:10px;">
                <a class="btn btn-outline-secondary pv-btn" href="@Url.Action("DoctorHome","ClaimForm")">
                    <i class="bi bi-arrow-left"></i>
                    <span>@T("BackHome", "Back to Main Home")</span>
                </a>

                <a class="btn btn-outline-primary pv-btn" href="@Url.Action("Provider_Expended_services","ClaimForm")">
                    <i class="bi bi-receipt"></i>
                    <span>@T("GoExpended", "Go to Expended services")</span>
                </a>
            </div>

        </div>
    </div>
</div>

<div id="backring1">
    <div class="ring1" id="Loadingg">
        Loading
        <spana1></spana1>
    </div>
</div>

<script>
    // ===== Utils =====
    function exShowLoading() { $('#backring1').show(); $('#Loadingg').show(); }
    function exHideLoading() { $('#Loadingg').hide(); $('#backring1').hide(); }

    function exToNum(v) {
        if (v === null || v === undefined) return 0;
        var s = ('' + v).replace(/,/g, '').trim();
        var n = parseFloat(s);
        return isNaN(n) ? 0 : n;
    }

    function selectDate() {
        var table = $('#tblApprovals').DataTable();
        table.draw();
    }

    // Child table formatter
    function format(d) {
        var result =
            '<div class="p-2">' +
            '<table class="table table-sm table-bordered align-middle mb-0" style="width:100%">' +
            '<thead>' +
            '<tr>' +
            '<th>@T("Child_ServiceName","Service Name")</th>' +
            '<th>@T("Child_ServiceQnt","Service Qnt")</th>' +
            '<th>@T("Child_UnitAmt","Unit Amt")</th>' +
            '<th>@T("Child_ServiceAmt","Service Amt")</th>' +
            '<th>@T("Child_DeductAmt","Deduct Amt")</th>' +
            '<th>@T("Child_DiscountAmt","Discount Amt")</th>' +
            '<th>@T("Child_DueAmt","Due Amt")</th>' +
            '<th>@T("Child_RequestedAmt","Requested Amt")</th>' +
            '<th>@T("Child_DifferenceAmt","Difference Amt")</th>' +
            '<th>@T("Child_ServiceNote","Service Note")</th>' +
            '<th>@T("Child_Edit","Edit")</th>' +
            '</tr>' +
            '</thead><tbody>';

        for (var i = 0; i < d.OrderListDetails.length; i++) {
            var it = d.OrderListDetails[i];
            result +=
                '<tr>' +
                '<td>' + it.ServiceName + '</td>' +
                '<td>' + it.ServiceQnt + '</td>' +
                '<td>' + it.ServiceUnitAmt + '</td>' +
                '<td>' + it.ServiceAmt + '</td>' +
                '<td>' + it.ServiceDeductAmt + '</td>' +
                '<td>' + it.ServiceDiscountAmt + '</td>' +
                '<td>' + it.ServiceDueAmt + '</td>' +
                '<td>' + "<input type='number' class='form-control form-control-sm' style='min-width:160px; text-align:center; border-radius:12px; font-weight:800;' id='" + it.ClaimitemID + "' value='" + it.ServiceRequestedAmt + "' />" + '</td>' +
                '<td>' + it.ServiceDifferenceAmt + '</td>' +
                '<td>' + (it.ServiceNote || '') + '</td>' +
                '<td>' + "<button type='button' class='btn btn-success btn-sm' style='border-radius:12px;font-weight:900' onclick='show(this," + it.ClaimitemID + "," + it.ClaimID + ");'>@T("Child_Save","Save")</button>" + '</td>' +
                '</tr>';
        }

        result += '</tbody></table></div>';
        return result;
    }

    // Save requested amount
    function show(button, ClaimItemID, ClaimID) {
        exShowLoading();

        var row = $(button).closest("TR");
        var DueAmt = exToNum(row[0].cells.item(6).innerHTML);
        var requesAmt = exToNum($("#" + ClaimItemID).val());
        var ServiceAmt = exToNum(row[0].cells.item(3).innerHTML);

        var DifferanceAmt = (requesAmt - ServiceAmt).toFixed(2);
        row[0].cells.item(8).innerHTML = DifferanceAmt;

        var NewRequest = Number(DueAmt) + Number(DifferanceAmt);

        $.get("/ClaimForm/updaterequestAmt",
            { Claim_ID: ClaimID, ClaimItem_ID: ClaimItemID, reques_Amt: NewRequest, Differance_Amt: DifferanceAmt },
            function (data) {
                exHideLoading();

                if (data == "1") {
                    Swal.fire("Warning !", "@T("Msg_InvalidRequested","Select a valid Requested Amount again.")", "warning");
                } else {
                    var totalrequestAMT = Number(data[0]).toFixed(2);
                    var totalDifferanceAMT = Number(data[1]).toFixed(2);

                    var dt = $('#tblApprovals').DataTable();
                    dt.rows().every(function () {
                        var d = this.data();
                        if (d && ('' + d.ClaimID) === ('' + ClaimID)) {
                            d.TRequestedAmt = totalrequestAMT;
                            d.TDifferenceAmt = totalDifferanceAMT;
                            this.data(d).invalidate();
                        }
                    });

                    dt.draw(false);
                }
            }
        );
    }

    function exFillBranches(data) {
        var map = {};
        for (var i = 0; i < data.length; i++) {
            var b = (data[i].BranchName || '').toString().trim();
            if (b) map[b] = true;
        }

        var keys = Object.keys(map).sort();
        var $ddl = $('#exBranch');
        $ddl.empty().append('<option value="">@T("Branch_All","All Branches")</option>');
        for (var k = 0; k < keys.length; k++) {
            $ddl.append('<option value="' + keys[k] + '">' + keys[k] + '</option>');
        }
    }

    function exRecalcSelectedTotals() {
        var dt = $('#tblApprovals').DataTable();
        var totalSelected = 0;
        var totalReq = 0;
        var totalDiff = 0;

        dt.rows({ search: 'applied' }).every(function () {
            var $tr = $(this.node());
            var $cb = $tr.find('input.ex-rowcb');
            if ($cb.length && $cb.prop('checked') === true) {
                totalSelected++;
                totalReq += exToNum($tr.find('td:eq(9)').text());
                totalDiff += exToNum($tr.find('td:eq(10)').text());
            }
        });

        $('#sumSelectedCount').text(totalSelected);
        $('#sumSelectedRequested').text(totalReq.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
        $('#sumSelectedDiff').text(totalDiff.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
    }

    $(document).ready(function () {

        exHideLoading();
        exShowLoading();

        $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
            if (!settings.nTable || settings.nTable.id !== 'tblApprovals') return true;

            var toDate = $('#toDate').val();
            var fromDate = $('#fromDate').val();
            var formatedToDate = toDate ? new Date(toDate) : null;
            var formatedFromDate = fromDate ? new Date(fromDate) : null;

            var dateField = data[4];
            var formatedDateField = dateField ? new Date(dateField) : null;

            if (!formatedDateField || isNaN(formatedDateField.getTime())) return true;

            if (formatedToDate && formatedFromDate) return (formatedToDate >= formatedDateField && formatedDateField >= formatedFromDate);
            if (formatedToDate && !formatedFromDate) return (formatedToDate >= formatedDateField);
            if (!formatedToDate && formatedFromDate) return (formatedDateField >= formatedFromDate);
            return true;
        });

        $.ajax({
            url: "/ClaimForm/GetOrderList",
            type: "GET",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (data) {

                exFillBranches(data);

                var table = $("#tblApprovals").DataTable({
                    data: data,
                    searching: false,
                    ordering: false,
                    paging: false,
                    scrollCollapse: true,
                    deferRender: true,
                    info: true,
                    columnDefs: [{ targets: 4, type: "date-eu" }],
                    dom: 'Bfrtip',
                    buttons: ['copy', 'csv', 'excel', 'print'],
                    columns: [
                        { className: 'details-control', orderable: false, data: null, defaultContent: '' },
                        { data: "ClaimID" },
                        { data: "ClaimFormNum" },
                        { data: "CardNumber" },
                        { data: "ProcedureDate" },
                        { data: "TClaimAmt" },
                        { data: "TDeductAmt" },
                        { data: "TDiscountAmt" },
                        { data: "NetClaimedAmt" },
                        { data: "TRequestedAmt" },
                        { data: "TDifferenceAmt" },
                        { data: "BranchName" },
                        {
                            data: null,
                            orderable: false,
                            searchable: false,
                            render: function (d, type, row, meta) {
                                var id = 'cb_' + meta.row;
                                return '' +
                                    '<div class="checkbox-wrapper-19">' +
                                    '  <input type="checkbox" class="ex-rowcb" id="' + id + '">' +
                                    '  <label style="background-color:white" for="' + id + '" class="check-box"></label>' +
                                    '</div>';
                            }
                        }
                    ],
                    order: [[0, 'desc']]
                });

                $('#sumTotalRows').text(table.rows().count());

                $('#exSearch').off('keyup').on('keyup', function () {
                    table.search(this.value).draw();
                    exRecalcSelectedTotals();
                });

                $('#exBranch').off('change').on('change', function () {
                    var val = this.value || '';
                    if (val === '') table.column(11).search('', true, false).draw();
                    else table.column(11).search('^' + $.fn.dataTable.util.escapeRegex(val) + '$', true, false).draw();
                    exRecalcSelectedTotals();
                });

                $('#tblApprovals tbody').on('click', 'td.details-control', function () {
                    var tr = $(this).closest('tr');
                    var row = table.row(tr);

                    if (row.child.isShown()) {
                        row.child.hide();
                        tr.removeClass('shown');
                    } else {
                        row.child(format(row.data())).show();
                        tr.addClass('shown');
                    }
                });

                $('#select_all').off('change').on('change', function () {
                    var checked = $(this).prop('checked') === true;
                    table.rows({ search: 'applied' }).every(function () {
                        var $tr = $(this.node());
                        $tr.find('input.ex-rowcb').prop('checked', checked);
                    });
                    exRecalcSelectedTotals();
                });

                $(document).off('change', '#tblApprovals tbody input.ex-rowcb');
                $(document).on('change', '#tblApprovals tbody input.ex-rowcb', function () {
                    exRecalcSelectedTotals();
                });

                window.selectDate = function () {
                    table.draw();
                    exRecalcSelectedTotals();
                };

                $(document).off('click', '#Send_To_Pay');
                $(document).on('click', '#Send_To_Pay', function (e) {
                    e.preventDefault();

                    Swal.fire({
                        title: "@T("Confirm","Confirm")",
                        imageUrl: "/Images/Quationimg.jpg",
                        imageWidth: 550,
                        imageHeight: 225,
                        text: "@T("Msg_ConfirmSend","Are you sure you want to send Invoices to Accounting Department?")",
                        showCancelButton: true,
                        confirmButtonText: "@T("Confirm","Confirm")",
                        cancelButtonText: "@T("Cancel","Cancel")",
                        cancelButtonColor: "#700c0c"
                    }).then((result) => {

                        if (!result.isConfirmed) return;

                        exShowLoading();

                        var Claims_Services = [];
                        table.rows({ search: 'applied' }).every(function (idx) {
                            var $tr = $(this.node());
                            if ($tr.find('input.ex-rowcb').prop('checked') === true) {
                                var d = this.data();
                                Claims_Services.push({ Claim_Id: d.ClaimID });
                            }
                        });

                        if (Claims_Services.length === 0) {
                            exHideLoading();
                            Swal.fire("Warning !", "@T("Msg_SelectAtLeastOne","Please select at least one invoice.")", "warning");
                            return;
                        }

                        $.ajax({
                            type: "POST",
                            url: "/ClaimForm/Send_to_Accounting_Department",
                            data: JSON.stringify(Claims_Services),
                            contentType: "application/json; charset=utf-8",
                            dataType: "json",
                            success: function (r) {
                                exHideLoading();
                                if (r == "0") {
                                    Swal.fire("Warning !", "@T("Msg_SelectAtLeastOne","Please select at least one invoice.")", "warning");
                                } else {
                                    Swal.fire("Success", "@T("Msg_SuccessSent","Invoices have been sent successfully.")", "success")
                                        .then(function () {
                                            window.open('@Url.Action("Invoices_Audit", "ClaimForm")', '_self');
                                        });
                                }
                            },
                            error: function () {
                                exHideLoading();
                                Swal.fire("Error", "@T("Msg_ServerErrorSend","Server error while sending to Accounting.")", "error");
                            }
                        });
                    });
                });

                exRecalcSelectedTotals();
                exHideLoading();
            },
            error: function (ex) {
                exHideLoading();
                console.log(ex);
                Swal.fire("Error", "@T("Msg_LoadFailed","Failed to load invoices list.")", "error");
            }
        });
    });
</script>

@* ===== SignalR + notifications (keep your original logic as-is) ===== *@
<script type="text/javascript">
    document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
            $.connection.hub.stop();
        } else {
            $.connection.hub.start().done(function () {
                getData();
                getData1();
            }).fail(function (e) { });
        }
    });

    function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

    $(function () {
        var cus = $.connection.cusHub;

        cus.client.displayCustomer = function () { getData(); };
        cus.client.data = function () { getData1(); };
        cus.client.data1 = function () { getData2(); };

        $.connection.hub.start();
        getData();
        getData1();
        getData2();
    });

    function getData1() {
        try {
            $.ajax({
                url: $("#Getmessages").val(),
                type: 'GET',
                datatype: 'json',
                success: function (data1) {
                    $.get("/ClaimForm/getcountmessage", {}, function (data) {
                        if (data == 0) $('#MesaageCount').removeAttr("data-count");
                        else $('#MesaageCount').attr("data-count", data);
                    });
                }
            });
        } catch (err) { }
    }

    function getData() {
        try {
            $.ajax({
                url: $("#Get").val(),
                type: 'GET',
                datatype: 'json',
                success: function (data) {
                    var provid = 0;
                    var branchid = 0;
                    if ("@Session["providerid"]" != "" && "@Session["BranchID"]" != "") {
                        provid = parseInt("@Session["providerid"]");
                        branchid = parseInt("@Session["BranchID"]");
                    }
                    var ApprovePage = 0;
                    if ("@Session["ClaimForm_Approved"]" != "") {
                        ApprovePage = parseInt("@Session["ClaimForm_Approved"]");
                    }

                    $.get("/ClaimForm/getcountallert", {}, function (data1) {
                        if (data1 == 0) $('#NotifactionCount').removeAttr("data-count");
                        else $('#NotifactionCount').attr("data-count", data1);
                    });

                    $.each(data.listCus, function (i, model) {
                        if ((provid == model.ProviderID) && (branchid == model.BranchID) && (model.CardNumber != "0") && (model.ClaimFormNum != 0) && ($('#trigger').val() == "0") && (ApprovePage == 1)) {
                            $('#trigger').val("1");

                            $.connection.hub.disconnected(function () {
                                setTimeout(function () { $.connection.hub.start(); }, 5000);
                            });

                            $.get("/ClaimForm/DeactiveAlert", {}, function (data2) {
                                if ("@Session["ClaimForm_Approved"]" != "") {
                                    ClaimForm_Approv = parseInt("@Session["ClaimForm_Approved"]");
                                    if (ClaimForm_Approv == 1) {
                                        var sound = new Audio('/Media/alert.mp3');
                                        sound.autoplay = true;
                                        sound.muted = false;
                                        sound.play();
                                        setTimeout(function () {
                                            snackbar.classList.add('isShown');
                                            $('#CardNumbersnackbar').text(model.CardNumber)
                                            $('#Claimformsnackbar').text(model.ClaimFormNum)
                                            setTimeout(hideSnackbar, 5000);
                                            $('#trigger').val("0");
                                            if (data2 == 0) $('#NotifactionCount').removeAttr("data-count");
                                            else $('#NotifactionCount').attr("data-count", data2);
                                        }, 100);
                                    }
                                }
                            })
                        }
                    });
                }
            });
        } catch (err) { }
    }

    function getData2() {
        try {
            $.ajax({
                url: $("#Get1").val(),
                type: 'GET',
                datatype: 'json',
                success: function (data) {
                    var provid = 0;
                    var branchid = 0;
                    if ("@Session["providerid"]" != "" && "@Session["BranchID"]" != "") {
                        provid = parseInt("@Session["providerid"]");
                        branchid = parseInt("@Session["BranchID"]");
                    }
                    var ApprovePage = 0;
                    var ApprovePage1 = 0;
                    var ApprovePage2 = 0;

                    if ("@Session["ClaimForm_Approved"]" != "" || "@Session["Approval"]" != "" || "@Session["Doctor_ClaimForm"]" != "") {
                        ApprovePage = parseInt("@Session["ClaimForm_Approved"]");
                        ApprovePage1 = parseInt("@Session["Approval"]");
                        ApprovePage2 = parseInt("@Session["Doctor_ClaimForm"]");
                    }

                    $.get("/ClaimForm/getcountallertSmartCard", {}, function (data1) {
                        if (data1 == 0) $('#MemberSmartCardRequestsCount').removeAttr("data-count");
                        else $('#MemberSmartCardRequestsCount').attr("data-count", data1);
                    });

                    $.each(data.listCus, function (i, model) {
                        if ((provid == model.ProviderID) && (branchid == model.BranchID) && (model.CardNumber != "0") && ($('#trigger1').val() == "0") && (ApprovePage == 1 || ApprovePage1 == 1 || ApprovePage2 == 1)) {
                            $('#trigger1').val("1");

                            $.connection.hub.disconnected(function () {
                                setTimeout(function () { $.connection.hub.start(); }, 5000);
                            });

                            $.get("/ClaimForm/DeactiveAlertSmartCard", {}, function (data2) {
                                var sound = new Audio('/Media/alert.mp3');
                                sound.play();
                                setTimeout(function () {
                                    snackbarMember.classList.add('isShown');
                                    $('#CardNumbersnackbarMember').text(model.CardNumber)
                                    setTimeout(hideSnackbard1, 5000);
                                    $('#trigger1').val("0");
                                    if (data2 == 0) $('#MemberSmartCardRequestsCount').removeAttr("data-count");
                                    else $('#MemberSmartCardRequestsCount').attr("data-count", data2);
                                }, 100);
                            })
                        }
                    });
                }
            });
        } catch (err) { }
    }
</script>

<script>
    function refresh() {
        $.ajax({
            type: "POST",
            url: "/ClaimForm/CheckIfSessionValid",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (r) {
                if (r == "False") {
                    window.open('@Url.Action("login", "ClaimForm")', '_self');
                } else {
                    setTimeout(refresh, 5000);
                }
            }
        });
    }
    setTimeout(refresh, 1000);
</script>