@{
    ViewBag.Title = "Messanger";
    Layout = "~/Views/Shared/_LayoutV2.cshtml";

    Func<string, string, string> T = (key, fallback) =>
    {
        try
        {
            var o = HttpContext.GetGlobalResourceObject("Messanger", key);
            return (o == null) ? fallback : o.ToString();
        }
        catch { return fallback; }
    };
}

@Scripts.Render("~/bundles/jquery")
@Scripts.Render("~/bundles/bootstrap")

<script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
<script src="~/signalr/hubs" type="text/javascript"></script>
<script type="text/javascript" src="~/Scripts/moment-with-locales.min.js"></script>

@Html.Hidden("Get", Url.Action("Get", "Customer"))
@Html.Hidden("Getmessages", Url.Action("Getmessages", "Customer"))

<input type="hidden" id="trigger" value="0" />

<style>
    .ex-page .pv-shell {
        max-width: 1100px;
        margin: 0 auto;
    }

    .ex-page .pv-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
        margin: 8px 0 12px;
    }

    .ex-page .pv-title {
        font-size: 22px;
        font-weight: 900;
        color: #0b2b40;
    }

    .ex-page .pv-sub {
        font-size: 13px;
        font-weight: 700;
        color: rgba(15,23,42,.65);
        margin-top: 4px;
    }

    .ex-page .pv-card {
        background: #fff;
        border: 1px solid rgba(0,0,0,.08);
        border-radius: 18px;
        box-shadow: 0 12px 30px rgba(15,23,42,.06);
        overflow: hidden;
    }

    .chat-head {
        padding: 12px 14px;
        border-bottom: 1px solid rgba(0,0,0,.08);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
    }

    .chat-title {
        font-size: 16px;
        font-weight: 900;
        color: #0b2b40;
    }

    .chat-body {
        padding: 12px;
        height: 62vh;
        min-height: 420px;
        max-height: 70vh;
        overflow: auto;
        background: linear-gradient(180deg, rgba(24,169,153,.06), rgba(255,255,255,.0));
    }

    .msg {
        display: flex;
        gap: 10px;
        margin-bottom: 12px;
        align-items: flex-start;
    }

        .msg.right {
            flex-direction: row-reverse;
        }

        .msg .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid rgba(0,0,0,.08);
            flex: 0 0 auto;
        }

    .bubble {
        max-width: 78%;
        border-radius: 16px;
        padding: 10px 12px;
        border: 1px solid rgba(0,0,0,.08);
        box-shadow: 0 6px 18px rgba(15,23,42,.06);
        background: #f2f4f7;
    }

    .msg.right .bubble {
        background: teal;
        color: #fff;
        border-color: rgba(0,0,0,.0);
    }

    .meta {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        font-size: 12px;
        font-weight: 800;
        color: rgba(15,23,42,.55);
        margin-bottom: 6px;
    }

    .msg.right .meta {
        justify-content: flex-end;
        color: rgba(255,255,255,.85);
    }

    .text {
        font-size: 15px;
        line-height: 1.45;
        word-break: break-word;
    }

    .chat-footer {
        border-top: 1px solid rgba(0,0,0,.08);
        padding: 10px;
        background: #fff;
    }

    .chat-input {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    #message {
        min-height: 46px;
        border-radius: 14px;
        font-weight: 800;
    }

    #send {
        min-height: 46px;
        border-radius: 14px;
        font-weight: 900;
        padding: 0 18px;
        background: teal;
        border-color: teal;
        color: #fff;
        white-space: nowrap;
    }
</style>

<div class="ex-page">
    <div class="pv-shell">

        <div class="pv-header">
            <div>
                <div class="pv-title">@T("Title", "Messenger")</div>
                <div class="pv-sub">@T("SubTitle", "Chat with CMC and follow up messages")</div>
            </div>
        </div>

        <div class="pv-card">
            <div class="chat-head">
                <div class="chat-title">@T("ChatTitle", "Chat Messages")</div>
            </div>

            <div class="chat-body" id="Chatmessages"></div>

            <div class="chat-footer">
                <div class="chat-input">
                    <input type="text" id="message" name="message" class="form-control"
                           placeholder="@T("TypeMessage","Type message...")" />
                    <button type="button" id="send" class="btn">
                        @T("Send", "Send")
                    </button>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    function exScrollBottom() {
        var objDiv = document.getElementById("Chatmessages");
        if (!objDiv) return;
        objDiv.scrollTop = objDiv.scrollHeight;
    }

    function exEscapeHtml(s) {
        if (s === null || s === undefined) return '';
        return String(s)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function renderProviderMessage(providerName, branchName, dt, message, imageUrl) {
        var Date = moment(dt);
        var content =
            "<div class='msg'>" +
            "  <img class='avatar' src='" + imageUrl + "' alt='avatar' />" +
            "  <div class='bubble'>" +
            "    <div class='meta'><span>" + exEscapeHtml(providerName) + " ( " + exEscapeHtml(branchName) + " )</span><span>•</span><span>" + Date.format("DD-MM-YYYY HH:mm:ss") + "</span></div>" +
            "    <div class='text' style='text-align:left'>" + exEscapeHtml(message) + "</div>" +
            "  </div>" +
            "</div>";
        $('#Chatmessages').append(content);
    }

    function renderCMCMessage(cmcName, dt, message) {
        var Date = moment(dt);
        var content =
            "<div class='msg right'>" +
            "  <img class='avatar' src='/Images/administratormale.png' alt='avatar' />" +
            "  <div class='bubble'>" +
            "    <div class='meta'><span>" + exEscapeHtml(cmcName) + "</span><span>•</span><span>" + Date.format("DD-MM-YYYY HH:mm:ss") + "</span></div>" +
            "    <div class='text' style='text-align:right'>" + exEscapeHtml(message) + "</div>" +
            "  </div>" +
            "</div>";
        $('#Chatmessages').append(content);
    }

    // Send message
    $(document).off('click', '#send');
    $(document).on('click', '#send', function () {

        var msg = ($('#message').val() || '').trim();
        if (!msg) {
            // لو SweetAlert موجود في LayoutV2
            if (window.Swal) Swal.fire("Warning !", "@T("EmptyMessage","Please type a message first.")", "warning");
            return;
        }

        var $btn = $('#send');
        var oldText = $btn.text();
        $btn.prop('disabled', true).text('@T("Sending","Sending...")');

        $.get("/ClaimForm/ADDMessage", { message: msg }, function (data) {

            $("#message").val("");

            // data: [0]=name, [1]=branch, [2]=date, [3]=message
            var imageUrl = "@ViewBag.image";
            renderProviderMessage(data[0], data[1], data[2], data[3], imageUrl);
            exScrollBottom();

        }).always(function () {
            $btn.prop('disabled', false).text(oldText);
        });
    });

    // Enter to send
    $(document).off('keydown', '#message');
    $(document).on('keydown', '#message', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            $('#send').click();
        }
    });

    // SignalR / Refresh Messages (keep core logic)
    document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
            $.connection.hub.stop();
        } else {
            $.connection.hub.start().done(function () {
                getData();
                getData1();
            }).fail(function (e) { });
        }
    });

    $(function () {
        var cus = $.connection.cusHub;

        cus.client.displayCustomer = function () { getData(); };
        cus.client.data = function () { getData1(); };

        $.connection.hub.start();
        getData();
        getData1();
    });

function getData1() {
    try {
        $.ajax({
            url: $("#Getmessages").val(),
            type: 'GET',
            datatype: 'json',
            success: function (data1) {

                // ✅ زي القديم: أول ما أفتح صفحة الرسائل -> اشيل العداد فورًا
                setBadgeCount('MesaageCount', 0);

                // (اختياري) call زي القديم (بنستخدمه لو السيرفر بيعمل Mark as seen)
                $.get("/ClaimForm/showallmessage", {}, function () { });

                // (اختياري) call للـ count زي القديم لكن من غير ما نرجّع العداد تاني
                $.get("/ClaimForm/getcountmessage", {}, function () { });

                $('#Chatmessages').empty();

                $.each(data1.listCus, function (i, model) {
                    if (model.IsProvider == true) {
                        renderProviderMessage(model.ProviderName, model.BranchName, model.MessageDateTime, model.Message, "@ViewBag.image");
                    } else {
                        renderCMCMessage(model.CMCName, model.MessageDateTime, model.Message);
                    }
                });

                exScrollBottom();
            }
        });
    } catch (err) { }
}

    function getData() {
        try {
            $.ajax({
                url: $("#Get").val(),
                type: 'GET',
                datatype: 'json',
                success: function (data) {

                    var provid = 0;
                    var branchid = 0;
                    if ("@Session["providerid"]" != "" && "@Session["BranchID"]" != "") {
                        provid = parseInt("@Session["providerid"]");
                        branchid = parseInt("@Session["BranchID"]");
                    }
                    var ApprovePage = 0;
                    if ("@Session["ClaimForm_Approved"]" != "") {
                        ApprovePage = parseInt("@Session["ClaimForm_Approved"]");
                    }

                    $.get("/ClaimForm/getcountallert", {}, function (data1) {
                        setBadgeCount('NotifactionCount', data1);
                    });

                    $.each(data.listCus, function (i, model) {
                        if ((provid == model.ProviderID) && (branchid == model.BranchID) && (model.CardNumber != "0") && (model.ClaimFormNum != 0) && ($('#trigger').val() == "0") && (ApprovePage == 1)) {
                            $('#trigger').val("1");

                            $.connection.hub.disconnected(function () {
                                setTimeout(function () { $.connection.hub.start(); }, 5000);
                            });

                            $.get("/ClaimForm/DeactiveAlert", {}, function (data2) {
                                if ("@Session["ClaimForm_Approved"]" != "") {
                                    var ClaimForm_Approv = parseInt("@Session["ClaimForm_Approved"]");
                                    if (ClaimForm_Approv == 1) {
                                        var sound = new Audio('/Media/alert.mp3');
                                        sound.autoplay = true;
                                        sound.muted = false;
                                        sound.play();

                                        setTimeout(function () {
                                            snackbar.classList.add('isShown');
                                            $('#CardNumbersnackbar').text(model.CardNumber)
                                            $('#Claimformsnackbar').text(model.ClaimFormNum)
                                            setTimeout(hideSnackbar, 5000);

                                            $('#trigger').val("0");
                                            setBadgeCount('NotifactionCount', data2);
                                        }, 100);
                                    }
                                }
                            });
                        }
                    });
                }
            });
        } catch (err) { }
    }
</script>

<script>
    function refresh() {
        $.ajax({
            type: "POST",
            url: "/ClaimForm/CheckIfSessionValid",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (r) {
                if (r == "False") {
                    window.open('@Url.Action("login", "ClaimForm")', '_self');
                } else {
                    setTimeout(refresh, 5000);
                }
            }
        });
    }
    setTimeout(refresh, 1000);
</script>