@{
    ViewBag.Title = "Provider_Expended_services";
    Layout = "~/Views/Shared/_LayoutV2.cshtml";

    Func<string, string, string> T = (key, fallback) =>
    {
        try
        {
            var o = HttpContext.GetGlobalResourceObject("ProviderExpandedServices", key);
            return (o == null) ? fallback : o.ToString();
        }
        catch { return fallback; }
    };

    // ====== Summaries from ViewBag.services (C# only) ======
    decimal sumContract = 0m, sumDeduct = 0m, sumDiscount = 0m, sumDue = 0m, sumRequested = 0m, sumDiff = 0m;
    int totalClaims = 0;

    try
    {
        if (ViewBag.services != null)
        {
            foreach (var it in ViewBag.services)
            {
                totalClaims++;

                Func<string, decimal> getDec = (propName) =>
                {
                    try
                    {
                        var p = it.GetType().GetProperty(propName);
                        if (p == null) return 0m;
                        var v = p.GetValue(it, null);
                        if (v == null) return 0m;

                        // handle numeric/string
                        decimal d;
                        if (v is decimal) return (decimal)v;
                        if (v is double) return Convert.ToDecimal((double)v);
                        if (v is float) return Convert.ToDecimal((float)v);
                        if (v is int) return Convert.ToDecimal((int)v);
                        if (v is long) return Convert.ToDecimal((long)v);

                        var s = v.ToString();
                        // remove commas
                        s = s.Replace(",", "");
                        if (decimal.TryParse(s, out d)) return d;
                        return 0m;
                    }
                    catch { return 0m; }
                };

                sumContract += getDec("TClaimAmt");
                sumDeduct += getDec("TDeductAmt");
                sumDiscount += getDec("TDiscountAmt");
                sumDue += getDec("NetClaimedAmt");
                sumRequested += getDec("TRequestedAmt");
                sumDiff += getDec("TDifferenceAmt");
            }
        }
    }
    catch { }
}

@* ✅ لازم jQuery (حل مشكلة الأزرار/السيلكت/الداتا تيبل) *@
@Scripts.Render("~/bundles/jquery")

@* Bootstrap bundle (لو LayoutV2 فيه bootstrap، وجوده هنا مش هيكسر — لكن خليه زي صفحاتك القديمة) *@
@Scripts.Render("~/bundles/bootstrap")
<script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
<script src="~/signalr/hubs" type="text/javascript"></script>
<script type="text/javascript" src="~/Scripts/moment-with-locales.min.js"></script>

@* ===== DataTables Core (لازم) ===== *@
<link rel="stylesheet" href="~/Content/jquery.dataTables.min.css" />
<script type="text/javascript" src="~/Scripts/jquery.dataTables.min.js"></script>

@* Bootstrap5 integration (شكل أحسن) *@
<link rel="stylesheet" href="~/Content/dataTables.bootstrap5.min.css" />
<script type="text/javascript" src="~/Scripts/dataTables.bootstrap5.min.js"></script>

@Html.Hidden("Get", Url.Action("Get", "Customer"))
@Html.Hidden("Getmessages", Url.Action("Getmessages", "Customer"))
@Html.Hidden("Get1", Url.Action("Get1", "Customer"))

<input type="hidden" id="trigger" value="0" />
<input type="hidden" id="triggercount" value="0" />
<input type="hidden" id="trigger1" value="0" />
<input type="hidden" id="triggercount1" value="0" />

<style>
    /* ===== Page wrapper (consistent with LayoutV2 look) ===== */
    .ex-page .pv-shell { max-width: 1280px; margin: 0 auto; }
    .ex-page .pv-header{
        display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;
        margin: 8px 0 12px;
    }
    .ex-page .pv-title{ font-size:22px; font-weight:900; color:#0b2b40; }
    .ex-page .pv-sub{ font-size:13px; font-weight:700; color:rgba(15,23,42,.65); margin-top:4px; }
    .ex-page .pv-actions{ display:flex; gap:10px; flex-wrap:wrap; }
    .ex-page .pv-btn{ border-radius:14px; font-weight:900; padding:10px 14px; display:inline-flex; gap:10px; align-items:center; }

    .ex-page .pv-card{
        background:#fff;
        border:1px solid rgba(0,0,0,.08);
        border-radius:18px;
        box-shadow:0 12px 30px rgba(15,23,42,.06);
        padding:14px;
    }
    .ex-page .pv-card-title{ font-size:16px; font-weight:900; color:#0b2b40; margin-bottom:10px; }

    /* ===== Summary Cards (6 in a row) ===== */
    .ex-sum{
        display:grid;
        grid-template-columns: repeat(6, minmax(170px, 1fr));
        gap:12px;
        margin-bottom:12px;
    }
    @@media (max-width: 1400px){
        .ex-sum{ grid-template-columns: repeat(3, minmax(200px, 1fr)); }
    }
    @@media (max-width: 768px){
        .ex-sum{ grid-template-columns: 1fr; }
    }

    .ex-scard{
        background:#fff;
        border:1px solid rgba(0,0,0,.08);
        border-radius:16px;
        box-shadow:0 10px 26px rgba(15,23,42,.06);
        padding:12px 14px;
        display:flex; gap:12px; align-items:center;
        min-height:74px;
    }
    .ex-sicon{
        width:44px;height:44px;border-radius:14px;
        display:flex;align-items:center;justify-content:center;
        background: rgba(24,169,153,.12);
        border:1px solid rgba(24,169,153,.22);
        color:#0b2b40; font-size:20px;
        flex:0 0 auto;
    }
    .ex-slabel{ font-size:12px; font-weight:900; color:rgba(15,23,42,.65); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .ex-svalue{ font-size:18px; font-weight:900; color:#0b2b40; direction:ltr; text-align:start; }

    /* ===== Controls ===== */
    .ex-controls{
        display:grid;
        grid-template-columns: 1.2fr 1.8fr 1fr;
        gap:12px;
        align-items:end;
        margin-bottom: 10px;
    }
    @@media (max-width: 992px){
        .ex-controls{ grid-template-columns: 1fr; }
    }

    .ex-search{ position:relative; }
    .ex-search i{ position:absolute; top:50%; transform:translateY(-50%); left:12px; color:rgba(15,23,42,.55); }
    html[dir="rtl"] .ex-search i{ left:auto; right:12px; }
    .ex-search input{ padding-left:38px; min-height:44px; border-radius:14px; }
    html[dir="rtl"] .ex-search input{ padding-left:12px; padding-right:38px; }

    .ex-select select{ min-height:44px; border-radius:14px; font-weight:800; }

    .ex-dates{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
    .ex-dates label{ font-size:13px; font-weight:900; color:rgba(15,23,42,.65); }
    .ex-dates input{ min-height:44px; border-radius:14px; }

    /* ===== Table wrapper / scroll ===== */
    .ex-table-wrap{
        overflow:auto;
        border-radius:14px;
        border:1px solid rgba(0,0,0,.08);
    }
    .ex-table-wrap table{ min-width: 1200px; }

    /* header */
    .ex-page table.dataTable thead th{
        background: rgba(24,169,153,.12) !important;
        border-bottom: 1px solid rgba(24,169,153,.22) !important;
        color:#0b2b40 !important;
        font-weight:900 !important;
        font-size:13px !important;
        white-space:nowrap;
        vertical-align:middle;
    }
    .ex-page table.dataTable td{
        font-size:13px;
        white-space:nowrap;
        vertical-align:middle;
    }

    /* buttons block */
    .ex-actions-row{
        display:flex;
        justify-content:center;
        gap:12px;
        flex-wrap:wrap;
        margin: 12px 0;
    }
    .ex-actions-row .btn{
        border-radius:14px;
        padding:10px 18px;
        font-weight:900;
    }

    /* old checkbox wrapper stays as-is */
    .checkbox-wrapper-19 { box-sizing:border-box; --background-color:#fff; --checkbox-height:25px; }
    .checkbox-wrapper-19 input[type=checkbox]{ display:none; }
    .checkbox-wrapper-19 .check-box{
        height:var(--checkbox-height); width:var(--checkbox-height);
        background-color:transparent;
        border:calc(var(--checkbox-height)*.1) solid #000;
        border-radius:5px; position:relative; display:inline-block;
        box-sizing:border-box; transition:border-color .2s ease; cursor:pointer;
    }
    .checkbox-wrapper-19 .check-box::before, .checkbox-wrapper-19 .check-box::after{
        box-sizing:border-box; position:absolute; height:0;
        width:calc(var(--checkbox-height)*.2);
        background-color:#34b93d; display:inline-block;
        transform-origin:left top; border-radius:5px; content:" ";
    }
    .checkbox-wrapper-19 .check-box::before{
        top:calc(var(--checkbox-height)*.72);
        left:calc(var(--checkbox-height)*.41);
        box-shadow:0 0 0 calc(var(--checkbox-height)*.05) var(--background-color);
        transform:rotate(-135deg);
    }
    .checkbox-wrapper-19 .check-box::after{
        top:calc(var(--checkbox-height)*.37);
        left:calc(var(--checkbox-height)*.05);
        transform:rotate(-45deg);
    }
    .checkbox-wrapper-19 input[type=checkbox]:checked + .check-box{ border-color:#34b93d; }
    .checkbox-wrapper-19 input[type=checkbox]:checked + .check-box::after{ height:calc(var(--checkbox-height)/2); }
    .checkbox-wrapper-19 input[type=checkbox]:checked + .check-box::before{ height:calc(var(--checkbox-height)*1.2); }

    /* Loading */
    #backring1{ background-color: rgba(0,0,0,.25); display:none; }
    .ring1{
        position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
        width:150px; height:150px; border:3px solid #9ac3b8; border-radius:50%;
        text-align:center; line-height:150px; font-size:20px; letter-spacing:2px;
        color:#fff000; text-transform:uppercase; text-shadow:0 0 10px #fff000;
        background-color:#11395c; box-shadow:0 0 20px rgba(0,0,0,.35);
    }
    .ring1:before{
        content:''; position:absolute; top:0; left:0; width:100%; height:100%;
        border:3px solid transparent; border-top:3px solid #fff000; border-right:3px solid #fff000;
        box-shadow:0 0 1em white, 0 0 0 1000vw rgba(224,222,222,.70);
        border-radius:50%; animation: animateC1 2s linear infinite;
    }
    spana1{ display:block; position:absolute; top:calc(50% - 2px); left:50%; width:50%; height:4px;
        background:transparent; transform-origin:left; animation: animate1 2s linear infinite;
    }
    spana1:before{
        content:''; position:absolute; width:16px; height:16px; border-radius:50%;
        background:#fff000; top:-6px; right:-8px; box-shadow:0 0 20px #fff000;
    }
    @@keyframes animateC1{ 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
    @@keyframes animate1{ 0%{transform:rotate(45deg);} 100%{transform:rotate(405deg);} }
</style>

<div class="ex-page">
    <div class="pv-shell">

        <div class="pv-header">
            <div>
                <div class="pv-title">@T("Title", "Expanded Services")</div>
                <div class="pv-sub">@T("SubTitle", "Select invoices and send to accounting")</div>
            </div>
            <div class="pv-actions">
                <a class="btn btn-outline-secondary pv-btn" href="@Url.Action("DoctorHome","ClaimForm")">
                    <i class="bi bi-arrow-left"></i>
                    <span>@T("BackHome", "Back to Home")</span>
                </a>

                <a class="btn btn-outline-primary pv-btn" href="@Url.Action("PaymentInquiry","ClaimForm")">
                    <i class="bi bi-cash-coin"></i>
                    <span>@T("GoPaymentInquiry", "Go to Payment Inquiry")</span>
                </a>
            </div>
        </div>

        <div class="pv-card">
            <div class="pv-card-title">@T("Legend", "Expended services")</div>

            @* ===== Summaries (C# only) ===== *@
        <div class="ex-sum">

            <div class="ex-scard">
                <div class="ex-sicon"><i class="bi bi-list-check"></i></div>
                <div>
                    <div class="ex-slabel">@T("Sum_TotalClaims", "Total Claims")</div>
                    <div class="ex-svalue">@totalClaims</div>
                </div>
            </div>

            <div class="ex-scard">
                <div class="ex-sicon"><i class="bi bi-dash-circle"></i></div>
                <div>
                    <div class="ex-slabel">@T("Col_DeductAmt", "Deductable Amt")</div>
                    <div class="ex-svalue">@sumDeduct.ToString("N2")</div>
                </div>
            </div>

            <div class="ex-scard">
                <div class="ex-sicon"><i class="bi bi-percent"></i></div>
                <div>
                    <div class="ex-slabel">@T("Col_DiscountAmt", "Discount Amt")</div>
                    <div class="ex-svalue">@sumDiscount.ToString("N2")</div>
                </div>
            </div>

            <div class="ex-scard">
                <div class="ex-sicon"><i class="bi bi-cash-stack"></i></div>
                <div>
                    <div class="ex-slabel">@T("Col_DueAmt", "Due Amt")</div>
                    <div class="ex-svalue">@sumDue.ToString("N2")</div>
                </div>
            </div>

            <div class="ex-scard">
                <div class="ex-sicon"><i class="bi bi-receipt"></i></div>
                <div>
                    <div class="ex-slabel">@T("Col_RequestedAmt", "Requested Amt")</div>
                    <div class="ex-svalue">@sumRequested.ToString("N2")</div>
                </div>
            </div>

            <div class="ex-scard">
                <div class="ex-sicon"><i class="bi bi-arrow-left-right"></i></div>
                <div>
                    <div class="ex-slabel">@T("Col_DifferenceAmt", "Difference Amt")</div>
                    <div class="ex-svalue">@sumDiff.ToString("N2")</div>
                </div>
            </div>

        </div>
            @* ===== Controls: search + branch filter + dates ===== *@
            <div class="ex-controls">
                <div class="ex-search">
                    <i class="bi bi-search"></i>
                    <input id="exSearch" type="text" class="form-control" placeholder="@T("Search","Search...")" />
                </div>

                <div class="ex-select">
                    @{
                        // Build branches list from ViewBag.services (C# only)
                        var branches = new List<string>();
                        try
                        {
                            if (ViewBag.services != null)
                            {
                                foreach (var it in ViewBag.services)
                                {
                                    var p = it.GetType().GetProperty("BranchName");
                                    if (p != null)
                                    {
                                        var v = p.GetValue(it, null);
                                        if (v != null)
                                        {
                                            var s = v.ToString();
                                            if (!string.IsNullOrWhiteSpace(s) && !branches.Contains(s))
                                            { branches.Add(s); }
                                        }
                                    }
                                }
                            }
                        }
                        catch { }
                        branches.Sort();
                    }
                    <select id="exBranch" class="form-select">
                        <option value="">@T("Branch_All", "All Branches")</option>
                        @foreach (var b in branches)
                        {
                            <option value="@b">@b</option>
                        }
                    </select>
                </div>

                <div class="ex-dates">
                    <div>
                        <label>@T("FromDate", "From Date")</label>
                        <input type="date" id="fromDate" name="fromDate" class="form-control" onchange="selectDate()" />
                    </div>
                    <div>
                        <label>@T("ToDate", "To Date")</label>
                        <input type="date" id="toDate" name="toDate" class="form-control" onchange="selectDate()" />
                    </div>
                </div>
            </div>

            <div class="ex-actions-row">
                <button type="button" id="Recover_To_Audit" class="btn btn-success btn-lg">
                    <span class="glyphicon glyphicon-edit"></span>&nbsp;
                    @T("RecoverToAudit", "Recover To Audit")
                </button>
            </div>

            <div class="ex-table-wrap">
                <table class="table table-hover align-middle mb-0" id="Claim_Services2" cellpadding="0" cellspacing="0">
                    <thead>
                        <tr>
                            <th>
                                <div class="checkbox-wrapper-19">
                                    <input type="checkbox" id="select_all">
                                    <label style="background-color:white" for="select_all" class="check-box"></label>
                                </div>
                            </th>
                            <th>@T("Col_ClaimID", "Claim ID")</th>
                            <th>@T("Col_ClaimFormNum", "ClaimForm Number")</th>
                            <th>@T("Col_CardNumber", "Card Number")</th>
                            <th>@T("Col_ProcedureDate", "Procedure Date")</th>
                            <th>@T("Col_ContractAmt", "Contract Amt")</th>
                            <th>@T("Col_DeductAmt", "Deductable Amt")</th>
                            <th>@T("Col_DiscountAmt", "Discount Amt")</th>
                            <th>@T("Col_DueAmt", "Due Amt")</th>
                            <th>@T("Col_RequestedAmt", "Requested Amt")</th>
                            <th>@T("Col_DifferenceAmt", "Difference Amt")</th>
                            <th>@T("Col_BranchName", "Branch Name")</th>
                        </tr>
                    </thead>

                    <tbody>
                        @{ int i = 0; }
                        @foreach (var item in ViewBag.services)
                        {
                            var idd = "IsACTIVE1" + i;
                            i++;
                            <tr>
                                <td>
                                    <div class="checkbox-wrapper-19">
                                        <input type="checkbox" id="@idd">
                                        <label style="background-color:white" for="@idd" class="check-box"></label>
                                    </div>
                                </td>
                                <td>@item.GetType().GetProperty("ClaimID").GetValue(item)</td>
                                <td>@item.GetType().GetProperty("ClaimFormNum").GetValue(item)</td>
                                <td>@item.GetType().GetProperty("CardNumber").GetValue(item)</td>
                                <td>@item.GetType().GetProperty("ProcedureDate").GetValue(item).ToString("yyyy-MM-dd")</td>
                                <td>@item.GetType().GetProperty("TClaimAmt").GetValue(item)</td>
                                <td>@item.GetType().GetProperty("TDeductAmt").GetValue(item)</td>
                                <td>@item.GetType().GetProperty("TDiscountAmt").GetValue(item)</td>
                                <td>@item.GetType().GetProperty("NetClaimedAmt").GetValue(item)</td>
                                <td>@item.GetType().GetProperty("TRequestedAmt").GetValue(item)</td>
                                <td>@item.GetType().GetProperty("TDifferenceAmt").GetValue(item)</td>
                                <td>@item.GetType().GetProperty("BranchName").GetValue(item)</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <br />
            <div style="text-align:center">
                <label style="color:dodgerblue;font-size:15px">@T("SelectedCount", "Invoices Count")</label>
                <input type="text" size="20" id="Invoices_Count" name="Invoices_Count" value="0" readonly style="max-width:180px;border-radius:14px;text-align:center" />
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <label style="color:dodgerblue;font-size:15px">@T("SelectedRequested", "Invoices Requested Amt")</label>
                <input type="text" size="20" id="Invoices_RequestedAmt" name="Invoices_RequestedAmt" value="0" readonly style="max-width:220px;border-radius:14px;text-align:center" />
            </div>

            <div class="ex-actions-row">
                <button type="button" id="Send_To_Pay" class="btn btn-primary btn-lg">
                    <span class="glyphicon glyphicon-send"></span>&nbsp;
                    @T("SendToPay", "Send To Pay")
                </button>
            </div>

            <div class="pv-actions" style="justify-content:space-between; margin-top:10px;">
                <a class="btn btn-outline-secondary pv-btn" href="@Url.Action("DoctorHome","ClaimForm")">
                    <i class="bi bi-arrow-left"></i>
                    <span>@T("BackHome", "Back to Home")</span>
                </a>

                <a class="btn btn-outline-primary pv-btn" href="@Url.Action("PaymentInquiry","ClaimForm")">
                    <i class="bi bi-cash-coin"></i>
                    <span>@T("GoPaymentInquiry", "Go to Payment Inquiry")</span>
                </a>
            </div>

        </div>
    </div>
</div>

<div id="backring1">
    <div class="ring1" id="Loadingg">
        Loading
        <spana1></spana1>
    </div>
</div>

<script>
    // ===== keep your original date filter logic =====
    function selectDate() {
        var table = $('#Claim_Services2').DataTable();
        table.draw();
    }

    $(document).ready(function () {

        $("#Loadingg").hide();

        // ===== DataTables init (IMPORTANT: enable search + scroll) =====
        var dt = $('#Claim_Services2').DataTable({
            paging: false,
            ordering: false,
            searching: true,
            scrollX: false,
            autoWidth: true,
            info: false
        });

        // Search box
        $('#exSearch').on('keyup', function () {
            dt.search(this.value).draw();
        });

        // Branch filter (column 11 = Branch Name)
        $('#exBranch').on('change', function () {
            var val = this.value || '';
            // exact match
            if (val === '') {
                dt.column(11).search('', true, false).draw();
            } else {
                dt.column(11).search('^' + $.fn.dataTable.util.escapeRegex(val) + '$', true, false).draw();
            }
        });

        // Date filter (keeps your existing logic but fixed indexes)
        $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
            if (settings.nTable && settings.nTable.id !== 'Claim_Services2') return true;

            var toDate = $('#toDate').val();
            var fromDate = $('#fromDate').val();
            var formatedToDate = toDate ? new Date(toDate) : '';
            var formatedFromDate = fromDate ? new Date(fromDate) : '';

            // Procedure Date column index = 4 (0-based in data array because first checkbox is col0)
            var dateField = data[4];
            var formatedDateField = dateField ? new Date(dateField) : '';

            if (formatedToDate && formatedFromDate && formatedDateField) {
                return formatedToDate >= formatedDateField && formatedDateField >= formatedFromDate;
            } else if (formatedToDate && !formatedFromDate && formatedDateField) {
                return formatedToDate >= formatedDateField;
            } else if (!formatedToDate && formatedFromDate && formatedDateField) {
                return formatedDateField >= formatedFromDate;
            } else if (!formatedToDate && !formatedFromDate) {
                return true;
            }
            return false;
        });

    });
</script>

@* ======= (كل سكريبتاتك القديمة كما هي بدون تغيير) ======= *@
<script>
    function topFunction() {
        document.body.scrollTop = 0;
        document.documentElement.scrollTop = 0;
    }
    function BottomFunction() {
        window.scrollTo(0, document.body.scrollHeight);
    }
</script>

<script>
    // =========================
    // ✅ PATCH MODE (Stable with DataTables)
    // =========================

    function exShowLoading() {
        $('#backring1').show();
        $('#Loadingg').show();
    }
    function exHideLoading() {
        $('#Loadingg').hide();
        $('#backring1').hide();
    }

    function exToNum(v) {
        if (v === null || v === undefined) return 0;
        var s = ('' + v).replace(/,/g, '').trim();
        var n = parseFloat(s);
        return isNaN(n) ? 0 : n;
    }

    function exRecalcSelectedTotals() {
        var dt = $('#Claim_Services2').DataTable();
        var totalCount = 0;
        var totalRequested = 0;

        // ✅ احسب على كل الصفوف الموجودة (حتى لو في فلتر)
        dt.rows({ search: 'applied' }).every(function () {
            var node = this.node();
            var $tr = $(node);
            var $cb = $tr.find('td:eq(0) input[type=checkbox]');
            if ($cb.length && $cb.prop('checked') === true) {
                totalCount++;

                // Requested Amt column = 9 (حسب ترتيب الجدول عندك)
                var requestedText = $tr.find('td:eq(9)').text();
                totalRequested += exToNum(requestedText);
            }
        });

        $('#Invoices_Count').val(totalCount);
        $('#Invoices_RequestedAmt').val(totalRequested.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
    }

    $(document).ready(function () {

        // ✅ تأكد إن DataTable متعملش مرتين
        var dt;
        if ($.fn.DataTable.isDataTable('#Claim_Services2')) {
            dt = $('#Claim_Services2').DataTable();
        } else {
            dt = $('#Claim_Services2').DataTable({
                paging: false,
                ordering: false,
                searching: true,
                info: false,
                autoWidth: true
            });
        }

        // ✅ Search box
        $('#exSearch').off('keyup').on('keyup', function () {
            dt.search(this.value).draw();
            // بعد الفلترة ممكن تتغير الصفوف الظاهرة
            exRecalcSelectedTotals();
        });

        // ✅ Branch filter (column 11 = BranchName)
        $('#exBranch').off('change').on('change', function () {
            var val = this.value || '';
            if (val === '') {
                dt.column(11).search('', true, false).draw();
            } else {
                dt.column(11).search('^' + $.fn.dataTable.util.escapeRegex(val) + '$', true, false).draw();
            }
            exRecalcSelectedTotals();
        });

        // ✅ Date filter (محفوظ زي ما عندك) — بس نخليه يشتغل على الجدول ده فقط
        $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
            if (!settings.nTable || settings.nTable.id !== 'Claim_Services2') return true;

            var toDate = $('#toDate').val();
            var fromDate = $('#fromDate').val();
            var formatedToDate = toDate ? new Date(toDate) : null;
            var formatedFromDate = fromDate ? new Date(fromDate) : null;

            // Procedure Date column index = 4
            var dateField = data[4];
            var formatedDateField = dateField ? new Date(dateField) : null;

            if (!formatedDateField || isNaN(formatedDateField.getTime())) return true;

            if (formatedToDate && formatedFromDate) return (formatedToDate >= formatedDateField && formatedDateField >= formatedFromDate);
            if (formatedToDate && !formatedFromDate) return (formatedToDate >= formatedDateField);
            if (!formatedToDate && formatedFromDate) return (formatedDateField >= formatedFromDate);
            return true;
        });

        // ✅ لما التاريخ يتغير
        window.selectDate = function () {
            dt.draw();
            exRecalcSelectedTotals();
        };

        // =========================
        // ✅ FIX: checkbox selection / select all
        // =========================

        // لما أي checkbox يتغير
        $(document).off('change', '#Claim_Services2 tbody input[type=checkbox]');
        $(document).on('change', '#Claim_Services2 tbody input[type=checkbox]', function () {
            exRecalcSelectedTotals();
        });

        // Select all
        $('#select_all').off('change').on('change', function () {
            var checked = $(this).prop('checked') === true;

            // ✅ طبق على الصفوف الظاهرة فقط (search applied)
            dt.rows({ search: 'applied' }).every(function () {
                var $tr = $(this.node());
                var $cb = $tr.find('td:eq(0) input[type=checkbox]');
                if ($cb.length) $cb.prop('checked', checked);
            });

            exRecalcSelectedTotals();
        });

        // =========================
        // ✅ FIX: Buttons (Recover / Send) — Delegated bind ثابت
        // =========================

        $(document).off('click', '#Send_To_Pay');
        $(document).on('click', '#Send_To_Pay', function (e) {
            e.preventDefault();
            e.stopPropagation();

            Swal.fire({
                title: "Confirm",
                imageUrl: "/Images/Quationimg.jpg",
                imageWidth: 550,
                imageHeight: 225,
                text: "Are you Sure you want to sent Claims to Tristar Accounting ?",
                showCancelButton: true,
                confirmButtonText: "Confirm",
                cancelButtonColor: "#700c0c"
            }).then((result) => {
                if (!result.isConfirmed) return;

                exShowLoading();

                // ✅ اجمع المختارين من الصفوف الظاهرة (بدون ما نكسر DataTable)
                var Claims_Services = [];
                var sumDue = 0;
                var earliest = null;
                var datebefore = "";

                dt.rows({ search: 'applied' }).every(function () {
                    var $tr = $(this.node());
                    var $cb = $tr.find('td:eq(0) input[type=checkbox]');

                    if ($cb.length && $cb.prop('checked') === true) {

                        var Claim_Service = {};
                        Claim_Service.Claim_Id = $tr.find('td:eq(1)').text().trim();
                        Claim_Service.ClaimForm_Number = $tr.find('td:eq(2)').text().trim();
                        Claim_Service.Card_Number = $tr.find('td:eq(3)').text().trim();
                        Claim_Service.Procedure_Date = $tr.find('td:eq(4)').text().trim();

                        Claim_Service.Contract_Amt = exToNum($tr.find('td:eq(5)').text());
                        Claim_Service.Deductable_Amt = exToNum($tr.find('td:eq(6)').text());
                        Claim_Service.Discount_Amt = exToNum($tr.find('td:eq(7)').text());
                        Claim_Service.Due_Amt = exToNum($tr.find('td:eq(8)').text());
                        Claim_Service.Requested_Amt = exToNum($tr.find('td:eq(9)').text());

                        sumDue += Claim_Service.Due_Amt;

                        var d = new Date(Claim_Service.Procedure_Date);
                        if (!isNaN(d.getTime())) {
                            if (earliest === null || d < earliest) {
                                earliest = d;
                                datebefore = Claim_Service.Procedure_Date;
                            }
                        }

                        Claims_Services.push(Claim_Service);
                    }
                });

                var j = Claims_Services.length;
                if (j === 0) {
                    exHideLoading();
                    Swal.fire("Warning !", "Please Select At Least One Claim To Sent Tristar Accounting To Pay. ", "warning");
                    return;
                }

                // ✅ منطق الـ 15 يوم زي القديم
                var datenow = new Date();
                var allowDate = earliest ? new Date(earliest) : new Date();
                allowDate.setDate(allowDate.getDate() + 15);

                if ((sumDue > 50000) || (datenow >= allowDate)) {

                    $.ajax({
                        type: "POST",
                        url: "/ClaimForm/Send_to_payy",
                        data: JSON.stringify(Claims_Services),
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        success: function (r) {
                            exHideLoading();

                            if (r == "0") {
                                Swal.fire("Warning !", "Please Select At Least One Claim To Sent Tristar Accounting To Pay. ", "warning");
                            } else if (r == "1") {
                                Swal.fire("Error !", "Claims are Sent To Tristar Accounting To Pay from a while. ", "error");
                            } else {
                                Swal.fire("Success", "Claims are Sent To Tristar Accounting To Pay. <br> Batch Number is : " + r, "success")
                                    .then(function () {
                                        window.open('@Url.Action("Provider_Expended_services", "ClaimForm")', '_self');
                                    });
                            }
                        },
                        error: function () {
                            exHideLoading();
                            Swal.fire("Error", "Server error while sending to pay.", "error");
                        }
                    });

                } else {
                    exHideLoading();
                    Swal.fire(
                        "Error !",
                        "Claims can not Sent To Tristar Accounting <br> After Pass 15 Days since add older Claim <br> older Claim Date : "
                        + moment(datebefore).format('DD-MM-YYYY')
                        + " <br> You Can Sent Batch in Date : "
                        + moment(allowDate).format('DD-MM-YYYY'),
                        "error"
                    );
                }

            });
        });

        $(document).off('click', '#Recover_To_Audit');
        $(document).on('click', '#Recover_To_Audit', function (e) {
            e.preventDefault();
            e.stopPropagation();

            Swal.fire({
                title: "Confirm",
                imageUrl: "/Images/Quationimg.jpg",
                imageWidth: 550,
                imageHeight: 225,
                text: "Are you Sure you want to Recover Invoices to Audit Department?",
                showCancelButton: true,
                confirmButtonText: "Confirm",
                cancelButtonColor: "#700c0c"
            }).then((result) => {
                if (!result.isConfirmed) return;

                exShowLoading();

                var Claims_Services = [];

                dt.rows({ search: 'applied' }).every(function () {
                    var $tr = $(this.node());
                    var $cb = $tr.find('td:eq(0) input[type=checkbox]');
                    if ($cb.length && $cb.prop('checked') === true) {
                        Claims_Services.push({
                            Claim_Id: $tr.find('td:eq(1)').text().trim()
                        });
                    }
                });

                if (Claims_Services.length === 0) {
                    exHideLoading();
                    Swal.fire("Warning !", "Please Select At Least One Invoice To Recover Audit Department To Pay. ", "warning");
                    return;
                }

                $.ajax({
                    type: "POST",
                    url: "/ClaimForm/recover_to_Audit_Department",
                    data: JSON.stringify(Claims_Services),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (r) {
                        exHideLoading();
                        if (r == "0") {
                            Swal.fire("Warning !", "Please Select At Least One Invoice To Recover Audit Department To Pay. ", "warning");
                        } else {
                            Swal.fire("Success", "Invoices are Recover To Audit Department To Pay.", "success")
                                .then(function () {
                                    window.open('@Url.Action("Provider_Expended_services", "ClaimForm")', '_self');
                                });
                        }
                    },
                    error: function () {
                        exHideLoading();
                        Swal.fire("Error", "Server error while recovering to audit.", "error");
                    }
                });

            });
        });

        // ✅ أول مرة احسب المختار
        exRecalcSelectedTotals();
        exHideLoading();
    });
</script>

<script type="text/javascript">
    document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
            $.connection.hub.stop();
        } else {
            $.connection.hub.start().done(function () {
                getData();
                getData1();
            }).fail(function (e) {});
        }
    });

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    $(function () {
        var cus = $.connection.cusHub;

        cus.client.displayCustomer = function () { getData(); };
        cus.client.data = function () { getData1(); };
        cus.client.data1 = function () { getData2(); };

        $.connection.hub.start();
        getData();
        getData1();
        getData2();
    });

    function getData1() {
        try {
            $.ajax({
                url: $("#Getmessages").val(),
                type: 'GET',
                datatype: 'json',
                success: function (data1) {
                    $.get("/ClaimForm/getcountmessage", {}, function (data) {
                        setBadgeCount('MesaageCount', data);
                    });
                }
            });
        } catch (err) { }
    }

    function getData() {
        try {
            $.ajax({
                url: $("#Get").val(),
                type: 'GET',
                datatype: 'json',
                success: function (data) {
                    var provid = 0;
                    var branchid = 0;
                    if ("@Session["providerid"]" != "" && "@Session["BranchID"]" != "") {
                        provid = parseInt("@Session["providerid"]");
                        branchid = parseInt("@Session["BranchID"]");
                    }
                    var ApprovePage = 0;
                    if ("@Session["ClaimForm_Approved"]" != "") {
                        ApprovePage = parseInt("@Session["ClaimForm_Approved"]");
                    }

                    $.get("/ClaimForm/getcountallert", {}, function (data1) {
                        setBadgeCount('NotifactionCount', data1);
                    });

                    $.each(data.listCus, function (i, model) {
                        if ((provid == model.ProviderID) && (branchid == model.BranchID) && (model.CardNumber != "0") && (model.ClaimFormNum != 0) && ($('#trigger').val() == "0") && (ApprovePage == 1)) {
                            $('#trigger').val("1");

                            $.connection.hub.disconnected(function () {
                                setTimeout(function () { $.connection.hub.start(); }, 5000);
                            });

                            $.get("/ClaimForm/DeactiveAlert", {}, function (data2) {
                                if ("@Session["ClaimForm_Approved"]" != "") {
                                    ClaimForm_Approv = parseInt("@Session["ClaimForm_Approved"]");
                                    if (ClaimForm_Approv == 1) {
                                        var sound = new Audio('/Media/alert.mp3');
                                        sound.autoplay = true;
                                        sound.muted = false;
                                        sound.play();
                                        setTimeout(function () {
                                            snackbar.classList.add('isShown');
                                            $('#CardNumbersnackbar').text(model.CardNumber)
                                            $('#Claimformsnackbar').text(model.ClaimFormNum)
                                            setTimeout(hideSnackbar, 5000);
                                            $('#trigger').val("0");
                                            setBadgeCount('NotifactionCount', data2);
                                        }, 100);
                                    }
                                }
                            })
                        }
                    });
                }
            });
        } catch (err) { }
    }

    function getData2() {
        try {
            $.ajax({
                url: $("#Get1").val(),
                type: 'GET',
                datatype: 'json',
                success: function (data) {

                    var provid = 0;
                    var branchid = 0;
                    if ("@Session["providerid"]" != "" && "@Session["BranchID"]" != "") {
                        provid = parseInt("@Session["providerid"]");
                        branchid = parseInt("@Session["BranchID"]");
                    }
                    var ApprovePage = 0;
                    var ApprovePage1 = 0;
                    var ApprovePage2 = 0;

                    if ("@Session["ClaimForm_Approved"]" != "" || "@Session["Approval"]" != "" || "@Session["Doctor_ClaimForm"]" != "") {
                        ApprovePage = parseInt("@Session["ClaimForm_Approved"]");
                        ApprovePage1 = parseInt("@Session["Approval"]");
                        ApprovePage2 = parseInt("@Session["Doctor_ClaimForm"]");
                    }

                    $.get("/ClaimForm/getcountallertSmartCard", {}, function (data1) {
                        setBadgeCount('MemberSmartCardRequestsCount', data1);
                    });

                    $.each(data.listCus, function (i, model) {
                        if ((provid == model.ProviderID) && (branchid == model.BranchID) && (model.CardNumber != "0") && ($('#trigger1').val() == "0") && (ApprovePage == 1 || ApprovePage1 == 1 || ApprovePage2 == 1)) {
                            $('#trigger1').val("1");

                            $.connection.hub.disconnected(function () {
                                setTimeout(function () { $.connection.hub.start(); }, 5000);
                            });

                            $.get("/ClaimForm/DeactiveAlertSmartCard", {}, function (data2) {
                                var sound = new Audio('/Media/alert.mp3');
                                sound.play();
                                setTimeout(function () {
                                    snackbarMember.classList.add('isShown');
                                    $('#CardNumbersnackbarMember').text(model.CardNumber)
                                    setTimeout(hideSnackbard1, 5000);
                                    $('#trigger1').val("0");
                                    setBadgeCount('MemberSmartCardRequestsCount', data2);
                                }, 100);
                            })
                        }
                    });
                }
            });
        } catch (err) { }
    }
</script>

<script>
    function refresh() {
        $.ajax({
            type: "POST",
            url: "/ClaimForm/CheckIfSessionValid",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (r) {
                if (r == "False") {
                    window.open('@Url.Action("login", "ClaimForm")', '_self');
                } else {
                    setTimeout(refresh, 5000);
                }
            }
        });
    }
    setTimeout(refresh, 1000);
</script>