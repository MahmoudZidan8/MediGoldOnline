@{
    ViewBag.Title = "DoctorHome";
    Layout = "~/Views/Shared/_LayoutV2.cshtml";

    Func<string, string, string> T = (key, fallback) =>
    {
        try
        {
            var o = HttpContext.GetGlobalResourceObject("DoctorHome", key);
            return (o == null) ? fallback : o.ToString();
        }
        catch { return fallback; }
    };
}
@* ✅ لازم jQuery (حل مشكلة الأزرار/السيلكت/الداتا تيبل) *@
@Scripts.Render("~/bundles/jquery")
@* Bootstrap bundle (لو LayoutV2 فيه bootstrap، وجوده هنا مش هيكسر — لكن خليه زي صفحاتك القديمة) *@
@Scripts.Render("~/bundles/bootstrap")
<script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
<script src="~/signalr/hubs" type="text/javascript"></script>

@Html.Hidden("Get", Url.Action("Get", "Customer"))
<script type="text/javascript" src="~/Scripts/moment-with-locales.min.js"></script>

@Html.Hidden("Getmessages", Url.Action("Getmessages", "Customer"))
<input type="hidden" id="trigger" value="0" />
<input type="hidden" id="triggercount" value="0" />
@Html.Hidden("Get1", Url.Action("Get1", "Customer"))

<input type="hidden" id="trigger1" value="0" />
<input type="hidden" id="triggercount1" value="0" />

<div class="page doctor-home-v2">

    <div class="dh2-header">
        <div>
            <div class="dh2-title">@T("DashboardTitle", "Dashboard")</div>
            <div class="dh2-sub">@T("Welcome", "Welcome")</div>
        </div>
        <div class="dh2-date">@DateTime.Now.ToString("dd/MM/yyyy")</div>
    </div>

    <div class="dh2-tiles">

        @if (Session["Medical_Services"] != null && int.Parse(Session["Medical_Services"].ToString()) == 1)
        {
            <a class="dh2-tile" href="@Url.Action("ClaimServices","ClaimForm")">
                <div class="dh2-icon"><i class="bi bi-heart-pulse"></i></div>
                <div class="dh2-body">
                    <div class="dh2-name">@T("MedicalServices_Title", "Medical Services")</div>
                    <div class="dh2-desc">@T("MedicalServices_Desc", "Enter medical services module")</div>
                </div>
                <div class="dh2-go"><i class="bi bi-arrow-right"></i></div>
            </a>
        }

        @if (Session["ClaimForm_Approved"] != null && int.Parse(Session["ClaimForm_Approved"].ToString()) == 1)
        {
            <a class="dh2-tile" href="@Url.Action("ProviderClaimFormApproved","ClaimForm")">
                <div class="dh2-icon"><i class="bi bi-check2-circle"></i></div>
                <div class="dh2-body">
                    <div class="dh2-name">@T("ClaimFormApproved_Title", "ClaimForm Approved")</div>
                    <div class="dh2-desc">@T("ClaimFormApproved_Desc", "Approved claims dashboard")</div>
                </div>
                <div class="dh2-go"><i class="bi bi-arrow-right"></i></div>
            </a>
        }

        @if (Session["Approval"] != null && int.Parse(Session["Approval"].ToString()) == 1)
        {
            <a class="dh2-tile" href="@Url.Action("Approval","ClaimForm")">
                <div class="dh2-icon"><i class="bi bi-clipboard-check"></i></div>
                <div class="dh2-body">
                    <div class="dh2-name">@T("Approval_Title", "Approval")</div>
                    <div class="dh2-desc">@T("Approval_Desc", "Approvals management")</div>
                </div>
                <div class="dh2-go"><i class="bi bi-arrow-right"></i></div>
            </a>

            <a class="dh2-tile" href="@Url.Action("Chronic_Approvals","ClaimForm")">
                <div class="dh2-icon"><i class="bi bi-activity"></i></div>
                <div class="dh2-body">
                    <div class="dh2-name">@T("ChronicApproval_Title", "Chronic Approval")</div>
                    <div class="dh2-desc">@T("ChronicApproval_Desc", "Chronic approvals workflow")</div>
                </div>
                <div class="dh2-go"><i class="bi bi-arrow-right"></i></div>
            </a>
        }

        @if (Session["Doctor_ClaimForm"] != null && int.Parse(Session["Doctor_ClaimForm"].ToString()) == 1)
        {
            <a class="dh2-tile" href="@Url.Action("Doctor_ClaimForm","ClaimForm")">
                <div class="dh2-icon"><i class="bi bi-file-medical"></i></div>
                <div class="dh2-body">
                    <div class="dh2-name">@T("DoctorClaimForm_Title", "Doctor ClaimForm")</div>
                    <div class="dh2-desc">@T("DoctorClaimForm_Desc", "Create & manage doctor claim forms")</div>
                </div>
                <div class="dh2-go"><i class="bi bi-arrow-right"></i></div>
            </a>

            <a class="dh2-tile" href="@Url.Action("Print_CancelClaimForm","ClaimForm")">
                <div class="dh2-icon"><i class="bi bi-printer"></i></div>
                <div class="dh2-body">
                    <div class="dh2-name">@T("PrintClaimForm_Title", "Print ClaimForm")</div>
                    <div class="dh2-desc">@T("PrintClaimForm_Desc", "Print / Cancel claim forms")</div>
                </div>
                <div class="dh2-go"><i class="bi bi-arrow-right"></i></div>
            </a>
        }

        @if ((Session["Medical_Services"] != null && int.Parse(Session["Medical_Services"].ToString()) == 1)
          || (Session["Doctor_ClaimForm"] != null && int.Parse(Session["Doctor_ClaimForm"].ToString()) == 1))
        {
            <a class="dh2-tile" href="@Url.Action("Print_CancelAPProval","ClaimForm")">
                <div class="dh2-icon"><i class="bi bi-receipt"></i></div>
                <div class="dh2-body">
                    <div class="dh2-name">@T("PrintCancelInvoice_Title", "Print & Cancel Invoice")</div>
                    <div class="dh2-desc">@T("PrintCancelInvoice_Desc", "Invoices printing & cancellation")</div>
                </div>
                <div class="dh2-go"><i class="bi bi-arrow-right"></i></div>
            </a>
        }

        @if (Session["Invoices_Audit"] != null && int.Parse(Session["Invoices_Audit"].ToString()) == 1)
        {
            <a class="dh2-tile" href="@Url.Action("Invoices_Audit","ClaimForm")">
                <div class="dh2-icon"><i class="bi bi-shield-check"></i></div>
                <div class="dh2-body">
                    <div class="dh2-name">@T("InvoicesAudit_Title", "Invoices Audit")</div>
                    <div class="dh2-desc">@T("InvoicesAudit_Desc", "Audit invoices and review status")</div>
                </div>
                <div class="dh2-go"><i class="bi bi-arrow-right"></i></div>
            </a>
        }

        @if (Session["Expanded_Services"] != null && int.Parse(Session["Expanded_Services"].ToString()) == 1)
        {
            <a class="dh2-tile" href="@Url.Action("Provider_Expended_services","ClaimForm")">
                <div class="dh2-icon"><i class="bi bi-buildings"></i></div>
                <div class="dh2-body">
                    <div class="dh2-name">@T("ExpandedServices_Title", "Expanded Services")</div>
                    <div class="dh2-desc">@T("ExpandedServices_Desc", "Expanded services list")</div>
                </div>
                <div class="dh2-go"><i class="bi bi-arrow-right"></i></div>
            </a>
        }

        @if (Session["Payment_Inquiry"] != null && int.Parse(Session["Payment_Inquiry"].ToString()) == 1)
        {
            <a class="dh2-tile" href="@Url.Action("PaymentInquiry","ClaimForm")">
                <div class="dh2-icon"><i class="bi bi-cash-coin"></i></div>
                <div class="dh2-body">
                    <div class="dh2-name">@T("PaymentInquiry_Title", "Payment Inquiry")</div>
                    <div class="dh2-desc">@T("PaymentInquiry_Desc", "Search & view payment status")</div>
                </div>
                <div class="dh2-go"><i class="bi bi-arrow-right"></i></div>
            </a>
        }

    </div>
</div>

@*eror messages*@
@if (ViewBag.ErorMessage != null)
{
    <script type="text/javascript">
        window.onload = function () {
            Swal.fire("Error !", "@ViewBag.ErorMessage", "error");
        };
    </script>
}

<script type="text/javascript">
    document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
            $.connection.hub.stop();
        } else {
            $.connection.hub.start().done(function () {
                getData();
                getData1();
            }).fail(function (e) { });
        }
    });

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    $(function () {
        var cus = $.connection.cusHub;

        cus.client.displayCustomer = function () {
            getData();
        };

        cus.client.data = function () {
            getData1();
        };

        cus.client.data1 = function () {
            getData2();
        };

        $.connection.hub.start();
        getData();
        getData1();
        getData2();
    });

    function getData1() {
        try {
            $.ajax({
                url: $("#Getmessages").val(),
                type: 'GET',
                datatype: 'json',
                success: function (data1) {
                    $.get("/ClaimForm/getcountmessage", {}, function (data) {
                        setBadgeCount('MesaageCount', data);
                    });

                    $.each(data1.listCus, function (i, model) { });
                }
            });
        }
        catch (err) { }
    }

    function getData() {
        try {
            $.ajax({
                url: $("#Get").val(),
                type: 'GET',
                datatype: 'json',
                success: function (data) {

                    var provid = 0;
                    var branchid = 0;

                    if ("@Session["providerid"]" != "" && "@Session["BranchID"]" != "") {
                        provid = parseInt("@Session["providerid"]");
                        branchid = parseInt("@Session["BranchID"]");
                        branchid = parseInt("@Session["BranchID"]");
                    }

                    var ApprovePage = 0;
                    if ("@Session["ClaimForm_Approved"]" != "") {
                        ApprovePage = parseInt("@Session["ClaimForm_Approved"]");
                    }

                    $.get("/ClaimForm/getcountallert", {}, function (data1) {
                        setBadgeCount('NotifactionCount', data1);
                    });

                    $.each(data.listCus, function (i, model) {

                        if ((provid == model.ProviderID) && (branchid == model.BranchID) &&
                            (model.CardNumber != "0") && (model.ClaimFormNum != 0) &&
                            ($('#trigger').val() == "0") && (ApprovePage == 1)) {

                            $('#trigger').val("1");

                            $.connection.hub.disconnected(function () {
                                setTimeout(function () {
                                    $.connection.hub.start();
                                }, 5000);
                            });

                            $.get("/ClaimForm/DeactiveAlert", {}, function (data2) {
                                if ("@Session["ClaimForm_Approved"]" != "") {
                                    ClaimForm_Approv = parseInt("@Session["ClaimForm_Approved"]");
                                    if (ClaimForm_Approv == 1) {
                                        var sound = new Audio('/Media/alert.mp3');
                                        sound.autoplay = true;
                                        sound.muted = false;
                                        sound.play();

                                        setTimeout(function () {
                                            snackbar.classList.add('isShown');
                                            $('#CardNumbersnackbar').text(model.CardNumber)
                                            $('#Claimformsnackbar').text(model.ClaimFormNum)
                                            setTimeout(hideSnackbar, 5000);

                                            $('#trigger').val("0");

                                            setBadgeCount('NotifactionCount', data2);
                                        }, 100);
                                    }
                                }
                            });
                        }
                    });
                }
            });
        }
        catch (err) { }
    }

    function getData2() {
        try {
            $.ajax({
                url: $("#Get1").val(),
                type: 'GET',
                datatype: 'json',
                success: function (data) {

                    var provid = 0;
                    var branchid = 0;
                    if ("@Session["providerid"]" != "" && "@Session["BranchID"]" != "") {
                        provid = parseInt("@Session["providerid"]");
                        branchid = parseInt("@Session["BranchID"]");
                    }

                    var ApprovePage = 0;
                    var ApprovePage1 = 0;
                    var ApprovePage2 = 0;

                    if ("@Session["ClaimForm_Approved"]" != "" || "@Session["Approval"]" != "" || "@Session["Doctor_ClaimForm"]" != "") {
                        ApprovePage = parseInt("@Session["ClaimForm_Approved"]");
                        ApprovePage1 = parseInt("@Session["Approval"]");
                        ApprovePage2 = parseInt("@Session["Doctor_ClaimForm"]");
                    }

                    $.get("/ClaimForm/getcountallertSmartCard", {}, function (data1) {
                        setBadgeCount('MemberSmartCardRequestsCount', data1);
                    });

                    $.each(data.listCus, function (i, model) {

                        if ((provid == model.ProviderID) && (branchid == model.BranchID) &&
                            (model.CardNumber != "0") && ($('#trigger1').val() == "0") &&
                            (ApprovePage == 1 || ApprovePage1 == 1 || ApprovePage2 == 1)) {

                            $('#trigger1').val("1");

                            $.connection.hub.disconnected(function () {
                                setTimeout(function () {
                                    $.connection.hub.start();
                                }, 5000);
                            });

                            $.get("/ClaimForm/DeactiveAlertSmartCard", {}, function (data2) {

                                var sound = new Audio('/Media/alert.mp3');
                                sound.play();

                                setTimeout(function () {
                                    snackbarMember.classList.add('isShown');
                                    $('#CardNumbersnackbarMember').text(model.CardNumber)
                                    setTimeout(hideSnackbard1, 5000);

                                    $('#trigger1').val("0");

                                    setBadgeCount('MemberSmartCardRequestsCount', data2);
                                }, 100);
                            });
                        }
                    });
                }
            });
        }
        catch (err) { }
    }
</script>

<script>
    function refresh() {
        $.ajax({
            type: "POST",
            url: "/ClaimForm/CheckIfSessionValid",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (r) {
                if (r == "False") {
                    window.open('@Url.Action("login", "ClaimForm")', '_self');
                }
                else {
                    setTimeout(refresh, 5000);
                }
            }
        });
    }
    setTimeout(refresh, 1000);
</script>

<script type="text/javascript">
    $(document).on('select2:open', () => {
        document.querySelector('.select2-search__field').focus();
    });
</script>