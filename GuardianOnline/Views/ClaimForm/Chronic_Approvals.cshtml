@{
    ViewBag.Title = "Chronic_Approvals";
    Layout = "~/Views/Shared/_LayoutV2.cshtml";

    Func<string, string, string> T = (key, fallback) =>
    {
        try
        {
            var o = HttpContext.GetGlobalResourceObject("ChronicApprovals", key);
            return (o == null) ? fallback : o.ToString();
        }
        catch { return fallback; }
    };
}

@* لازم jQuery قبل أي Plugins *@
@Scripts.Render("~/bundles/jquery")
@Scripts.Render("~/bundles/bootstrap")

<script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
<script src="~/signalr/hubs" type="text/javascript"></script>

@* ===== DataTables (لتفادي DataTable is not a function) ===== *@
<link rel="stylesheet" href="~/Content/jquery.dataTables.min.css" />
<script type="text/javascript" src="~/Scripts/jquery.dataTables.min.js"></script>

@* Bootstrap integration (اختياري لو موجود عندك) *@
<link rel="stylesheet" href="~/Content/dataTables.bootstrap5.min.css" />
<script type="text/javascript" src="~/Scripts/dataTables.bootstrap5.min.js"></script>

@* Buttons *@
<link rel="stylesheet" href="~/Content/buttons.dataTables.min.css" />
<script type="text/javascript" src="~/Scripts/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="~/Scripts/jszip.min.js"></script>
<script type="text/javascript" src="~/Scripts/vfs_fonts.js"></script>
<script type="text/javascript" src="~/Scripts/buttons.html5.min.js"></script>
<script type="text/javascript" src="~/Scripts/buttons.print.min.js"></script>

@* Date sorting *@
<script type="text/javascript" src="~/Scripts/date-eu.js"></script>

@Html.Hidden("Get", Url.Action("Get", "Customer"))
@Html.Hidden("Getmessages", Url.Action("Getmessages", "Customer"))
@Html.Hidden("Get1", Url.Action("Get1", "Customer"))

<input type="hidden" id="trigger" value="0" />
<input type="hidden" id="triggercount" value="0" />
<input type="hidden" id="trigger1" value="0" />
<input type="hidden" id="triggercount1" value="0" />

<style>
    /* ===== V2 wrapper ===== */
    .ex-page .pv-shell{ max-width:1280px; margin:0 auto; }
    .ex-page .pv-header{
        display:flex; align-items:flex-start; justify-content:space-between;
        gap:12px; flex-wrap:wrap; margin:8px 0 12px;
    }
    .ex-page .pv-title{ font-size:22px; font-weight:900; color:#0b2b40; }
    .ex-page .pv-sub{ font-size:13px; font-weight:700; color:rgba(15,23,42,.65); margin-top:4px; }

    .ex-page .pv-card{
        background:#fff; border:1px solid rgba(0,0,0,.08);
        border-radius:18px; box-shadow:0 12px 30px rgba(15,23,42,.06);
        padding:14px;
    }
    .ex-page .pv-card-title{ font-size:16px; font-weight:900; color:#0b2b40; margin-bottom:10px; }

    /* ===== Summary ===== */
    .ex-sum{
        display:grid;
        grid-template-columns: repeat(2, minmax(220px, 1fr));
        gap:12px;
        margin: 10px 0 12px;
    }
    @@media (max-width: 992px){
        .ex-sum{ grid-template-columns: 1fr; }
    }
    .ex-scard{
        background:#fff;
        border:1px solid rgba(0,0,0,.08);
        border-radius:16px;
        box-shadow:0 10px 26px rgba(15,23,42,.06);
        padding:12px 14px;
        display:flex; gap:12px; align-items:center;
        min-height:74px;
    }
    .ex-sicon{
        width:44px;height:44px;border-radius:14px;
        display:flex;align-items:center;justify-content:center;
        background: rgba(24,169,153,.12);
        border:1px solid rgba(24,169,153,.22);
        color:#0b2b40; font-size:20px;
        flex:0 0 auto;
    }
    .ex-slabel{ font-size:12px; font-weight:900; color:rgba(15,23,42,.65); }
    .ex-svalue{ font-size:18px; font-weight:900; color:#0b2b40; direction:ltr; text-align:start; }

    /* ===== Controls ===== */
    .ex-controls{
        display:flex; gap:12px; flex-wrap:wrap; align-items:end; justify-content:center;
        margin-bottom: 10px;
    }
    .ex-controls label{ font-size:13px; font-weight:900; color:rgba(15,23,42,.65); }
    .ex-controls input{ min-height:44px; border-radius:14px; }

    .ex-actions-row{
        display:flex; justify-content:center; gap:12px; flex-wrap:wrap; margin:12px 0;
    }
    .ex-actions-row .btn{ border-radius:14px; padding:10px 18px; font-weight:900; }

    /* ===== Table wrapper ===== */
    .ex-table-wrap{
        overflow:auto;
        border-radius:14px;
        border:1px solid rgba(0,0,0,.08);
    }
    .ex-table-wrap table{ min-width: 1200px; }

    .ex-page table.dataTable thead th{
        background: rgba(24,169,153,.12) !important;
        border-bottom: 1px solid rgba(24,169,153,.22) !important;
        color:#0b2b40 !important;
        font-weight:900 !important;
        font-size:13px !important;
        white-space:nowrap;
        vertical-align:middle;
        text-align:center;
    }
    .ex-page table.dataTable td{
        font-size:13px;
        white-space:nowrap;
        vertical-align:middle;
        text-align:center;
    }

    /* ===== details-control icons ===== */
    td.details-control { background: url('/Images/details_open.png') no-repeat center center; cursor:pointer; }
    tr.shown td.details-control { background: url('/Images/details_close.png') no-repeat center center; cursor:pointer; }

    /* ===== Loading overlay ===== */
    #backring1{ background-color: rgba(0,0,0,.25); display:none; }
    .ring1{
        position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
        width:150px; height:150px; border:3px solid #9ac3b8; border-radius:50%;
        text-align:center; line-height:150px; font-size:20px; letter-spacing:2px;
        color:#fff000; text-transform:uppercase; text-shadow:0 0 10px #fff000;
        background-color:#11395c; box-shadow:0 0 20px rgba(0,0,0,.35);
    }
    .ring1:before{
        content:''; position:absolute; top:0; left:0; width:100%; height:100%;
        border:3px solid transparent; border-top:3px solid #fff000; border-right:3px solid #fff000;
        box-shadow:0 0 1em white, 0 0 0 1000vw rgba(224,222,222,.70);
        border-radius:50%; animation: animateC1 2s linear infinite;
    }
    spana1{ display:block; position:absolute; top:calc(50% - 2px); left:50%; width:50%; height:4px;
        background:transparent; transform-origin:left; animation: animate1 2s linear infinite;
    }
    spana1:before{
        content:''; position:absolute; width:16px; height:16px; border-radius:50%;
        background:#fff000; top:-6px; right:-8px; box-shadow:0 0 20px #fff000;
    }
    @@keyframes animateC1{ 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
    @@keyframes animate1{ 0%{transform:rotate(45deg);} 100%{transform:rotate(405deg);} }

    /* ===== Checkbox wrapper (نفس اللي عندك) ===== */
    .checkbox-wrapper-19 { box-sizing:border-box; --background-color:#fff; --checkbox-height:25px; }
    .checkbox-wrapper-19 input[type=checkbox]{ display:none; }
    .checkbox-wrapper-19 .check-box{
        height:var(--checkbox-height); width:var(--checkbox-height);
        background-color:transparent;
        border:calc(var(--checkbox-height)*.1) solid #000;
        border-radius:5px; position:relative; display:inline-block;
        box-sizing:border-box; transition:border-color .2s ease; cursor:pointer;
    }
    .checkbox-wrapper-19 .check-box::before, .checkbox-wrapper-19 .check-box::after{
        box-sizing:border-box; position:absolute; height:0;
        width:calc(var(--checkbox-height)*.2);
        background-color:#34b93d; display:inline-block;
        transform-origin:left top; border-radius:5px; content:" ";
    }
    .checkbox-wrapper-19 .check-box::before{
        top:calc(var(--checkbox-height)*.72);
        left:calc(var(--checkbox-height)*.41);
        box-shadow:0 0 0 calc(var(--checkbox-height)*.05) var(--background-color);
        transform:rotate(-135deg);
    }
    .checkbox-wrapper-19 .check-box::after{
        top:calc(var(--checkbox-height)*.37);
        left:calc(var(--checkbox-height)*.05);
        transform:rotate(-45deg);
    }
    .checkbox-wrapper-19 input[type=checkbox]:checked + .check-box{ border-color:#34b93d; }
    .checkbox-wrapper-19 input[type=checkbox]:checked + .check-box::after{ height:calc(var(--checkbox-height)/2); }
    .checkbox-wrapper-19 input[type=checkbox]:checked + .check-box::before{ height:calc(var(--checkbox-height)*1.2); }

    /* ===== Floating arrows (زي القديم) ===== */
    .Up-Arrow, .Bottom-Arrow{ position:fixed; right:0; display:flex; cursor:pointer; z-index:20; }
    .Bottom-Arrow{ bottom:0; }
    .Up-Arrow{ bottom:111px; }
    .Up-round, .Bottom-round{
        position:relative; border:25px solid #fff; width:100px; height:100px; border-radius:100%;
        background-color:teal; transition: all .2s ease;
    }
    spanu, spana{ z-index:999; height:3px; margin:1px; width:16px; background:#fff; transition:.4s ease; display:block; position:absolute; }
    spanu:nth-child(1){ transform:rotate(-45deg); left:22%; bottom:35%; }
    spanu:nth-child(2){ transform:rotate(45deg); left:43%; bottom:35%; }
    spanu:nth-child(3){ transform:rotate(-45deg); left:22%; bottom:54%; }
    spanu:nth-child(4){ transform:rotate(45deg); left:43%; bottom:54%; }

    spana:nth-child(1){ transform:rotate(45deg); left:22%; bottom:35%; }
    spana:nth-child(2){ transform:rotate(-45deg); left:43%; bottom:35%; }
    spana:nth-child(3){ transform:rotate(45deg); left:22%; bottom:54%; }
    spana:nth-child(4){ transform:rotate(-45deg); left:43%; bottom:54%; }

    .Up-round:hover, .Bottom-round:hover{
        border:25px solid teal;
        box-shadow: rgba(25,186,46,.6) 0 3px 8px;
        transform: scale(1.03);
    }

</style>

<div class="ex-page">
    <div class="pv-shell">

        <div class="pv-header">
            <div>
                <div class="pv-title">@T("Title", "Chronic Approvals")</div>
                <div class="pv-sub">@T("SubTitle", "Review chronic approvals, edit requested price, then accept")</div>
            </div>
        </div>

        <div class="pv-card">
            <div class="pv-card-title">@T("CardTitle", "Chronic Approvals Content")</div>

            <div class="ex-controls">
                <div>
                    <label>@T("FromDate", "From Date")</label><br />
                    <input type="date" id="fromDate" class="form-control" onchange="selectDate()" />
                </div>
                <div>
                    <label>@T("ToDate", "To Date")</label><br />
                    <input type="date" id="toDate" class="form-control" onchange="selectDate()" />
                </div>
            </div>

            <div class="ex-sum">
                <div class="ex-scard">
                    <div class="ex-sicon"><i class="bi bi-list-check"></i></div>
                    <div>
                        <div class="ex-slabel">@T("InvoicesCount", "Invoices Count")</div>
                        <div class="ex-svalue" id="Invoices_Count">0</div>
                    </div>
                </div>

                <div class="ex-scard">
                    <div class="ex-sicon"><i class="bi bi-cash-stack"></i></div>
                    <div>
                        <div class="ex-slabel">@T("InvoicesDeductAmt", "Invoices Deductable Amt")</div>
                        <div class="ex-svalue" id="Invoices_RequestedAmt">0.00</div>
                    </div>
                </div>
            </div>

            <div class="ex-table-wrap">
                <table class="table table-hover align-middle mb-0" id="tblApprovals" cellpadding="0" cellspacing="0">
                    <thead>
                        <tr>
                            <th></th>
                            <th>@T("Col_ClaimID", "Claim ID")</th>
                            <th>@T("Col_ClaimFormNum", "ClaimForm Number")</th>
                            <th>@T("Col_CustomerName", "Customer Name")</th>
                            <th>@T("Col_MemberName", "Member Name")</th>
                            <th>@T("Col_CardNumber", "Card Number")</th>
                            <th>@T("Col_ProcedureDate", "Procedure Date")</th>
                            <th>@T("Col_ContractAmt", "Contract Amt")</th>
                            <th>@T("Col_RequestedAmt", "Requested Amt")</th>
                            <th>@T("Col_DeductPerc", "Deductable Perc")</th>
                            <th>@T("Col_DeductAmt", "Deductable Amt")</th>
                            <th>
                                <div class="checkbox-wrapper-19">
                                    <input type="checkbox" id="cbtestt">
                                    <label style="background-color:white" for="cbtestt" class="check-box"></label>
                                </div>
                            </th>
                        </tr>
                    </thead>
                </table>
            </div>

            <div class="ex-actions-row">
                <button type="button" id="Send_To_Pay" class="btn btn-primary btn-lg">
                    <span class="glyphicon glyphicon-send"></span>&nbsp; @T("AcceptChronic", "Accept Chronic Approvals")
                </button>
            </div>

            <div class="pv-header" style="margin-top:10px;">
                <a class="btn btn-outline-secondary" style="border-radius:14px;font-weight:900"
                   href="@Url.Action("DoctorHome","ClaimForm")">
                    <i class="bi bi-arrow-left"></i> @T("BackHome", "Back to Main Home")
                </a>

                <a class="btn btn-outline-primary" style="border-radius:14px;font-weight:900"
                   href="@Url.Action("Print_CancelAPProval","ClaimForm")">
                    <i class="bi bi-printer"></i> @T("GoPrintCancel", "Go to Print & Cancel Approval")
                </a>
            </div>
        </div>

    </div>
</div>

<div id="backring1">
    <div class="ring1" id="Loadingg">
        Loading
        <spana1></spana1>
    </div>
</div>

<div onclick="topFunction()" class="Up-Arrow">
    <div class="Up-round">
        <spanu></spanu><spanu></spanu><spanu></spanu><spanu></spanu>
    </div>
</div>

<div onclick="BottomFunction()" class="Bottom-Arrow">
    <div class="Bottom-round">
        <spana></spana><spana></spana><spana></spana><spana></spana>
    </div>
</div>

<script>
    function exShowLoading(){ $('#backring1').show(); $('#Loadingg').show(); }
    function exHideLoading(){ $('#Loadingg').hide(); $('#backring1').hide(); }

    function topFunction(){ document.body.scrollTop = 0; document.documentElement.scrollTop = 0; }
    function BottomFunction(){ window.scrollTo(0, document.body.scrollHeight); }

    function exToNum(v){
        if(v===null||v===undefined) return 0;
        var s = (''+v).replace(/,/g,'').trim();
        var n = parseFloat(s);
        return isNaN(n)?0:n;
    }

    function exUpdateSummaryFromSelected(){
        var totalCount = 0;
        var totalDeductAmt = 0;

        $("#tblApprovals TBODY TR").each(function () {
            var $tr = $(this);
            // skip child rows
            if ($tr.find("td.details-control").length === 0) return;

            var $cb = $tr.find("input.ex-rowcb");
            if ($cb.length && $cb.prop("checked") === true) {
                totalCount++;
                // Deductable Amt column index (10) in view columns (0-based td): 10
                totalDeductAmt += exToNum($tr.find("td:eq(10)").text());
            }
        });

        $('#Invoices_Count').text(totalCount);
        $('#Invoices_RequestedAmt').text(totalDeductAmt.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
    }

    function selectDate(){
        var table = $('#tblApprovals').DataTable();
        table.draw();
        exUpdateSummaryFromSelected();
    }

    // ==== Child table formatter (translated headers) ====
    function format(d) {
        var result =
            '<div class="p-2">' +
            '<table class="table table-sm table-bordered align-middle mb-0" style="width:100%">' +
            '<thead><tr>' +
            '<th>@T("Child_ServiceName","Service Name")</th>' +
            '<th>@T("Child_ServiceQnt","Service Qnt")</th>' +
            '<th>@T("Child_UnitPrice","Unit Price")</th>' +
            '<th>@T("Child_ServiceAmt","Service Amt")</th>' +
            '<th>@T("Child_RequestedPrice","Requested Price")</th>' +
            '<th>@T("Child_RequestedAmt","Requested Amt")</th>' +
            '<th>@T("Child_DeductPerc","Deduct Perc")</th>' +
            '<th>@T("Child_DeductAmt","Deduct Amt")</th>' +
            '<th>@T("Child_ServiceNote","Service Note")</th>' +
            '<th>@T("Child_Edit","Edit")</th>' +
            '</tr></thead><tbody>';

        for (var i = 0; i < d.OrderListDetails.length; i++) {
            var it = d.OrderListDetails[i];
            result +=
                '<tr>' +
                '<td>' + (it.ServiceName || '') + '</td>' +
                '<td>' + (it.ServiceQnt || 0) + '</td>' +
                '<td>' + (it.ServiceUnitAmt || 0) + '</td>' +
                '<td>' + (it.ServiceAmt || 0) + '</td>' +
                '<td>' + "<input type='number' class='form-control form-control-sm' style='min-width:160px; text-align:center; border-radius:12px; font-weight:800;' id='" + it.ClaimitemID + "' value='" + it.ServiceRequestedPrice + "' />" + '</td>' +
                '<td>' + (it.ServiceRequestedAmt || 0) + '</td>' +
                '<td>' + (it.ServiceDeductPerc || 0) + '</td>' +
                '<td>' + (it.ServiceDeductAmt || 0) + '</td>' +
                '<td>' + (it.ServiceNote || '') + '</td>' +
                '<td>' + "<button type='button' class='btn btn-success btn-sm' style='border-radius:12px;font-weight:900' onclick='show(this," + it.ClaimitemID + "," + it.ClaimID + ");'>@T("Save","Save")</button>" + '</td>' +
                '</tr>';
        }

        result += '</tbody></table></div>';
        return result;
    }

    function show(button, ClaimItemID, ClaimID) {
        var row = $(button).closest("TR");

        var ServiceQnt = exToNum(row[0].cells.item(1).innerHTML);
        var requesPrice = exToNum($("#" + ClaimItemID).val());
        var DeductPerc = exToNum(row[0].cells.item(6).innerHTML);

        var NewRequestAmt = Number(requesPrice) * Number(ServiceQnt);
        var NewDeductAmt = Number(NewRequestAmt) * Number(DeductPerc);

        row[0].cells.item(5).innerHTML = (NewRequestAmt).toFixed(2);
        row[0].cells.item(7).innerHTML = (NewDeductAmt).toFixed(2);

        $.get("/ClaimForm/updateChronicrequestAmt",
            { Claim_ID: ClaimID, ClaimItem_ID: ClaimItemID, reques_price: Number(requesPrice) },
            function (data) {
                if (data == "A") {
                    Swal.fire("@T("Warning","Warning!")", "@T("Msg_InvalidRequested","Select a valid requested amount again.")", "warning");
                } else {
                    // update main row totals in datatable by ClaimID
                    var dt = $('#tblApprovals').DataTable();
                    dt.rows().every(function () {
                        var d = this.data();
                        if (d && ('' + d.ClaimID) === ('' + ClaimID)) {
                            d.TRequestedAmt = Number(data[0]).toFixed(2);
                            // DeductAmt will be recalculated in UI below
                            this.data(d).invalidate();
                        }
                    });
                    dt.draw(false);

                    // after redraw update DeductAmt cell by scanning row (keeps old logic behavior)
                    $("#tblApprovals TBODY TR").each(function () {
                        var $tr = $(this);
                        var cid = $tr.find("TD").eq(1).text();
                        if ((''+cid) === (''+ClaimID)) {
                            var totalrequestAMT = Number(data[0]).toFixed(2);
                            var Deductt = exToNum($tr.find("TD").eq(9).text());
                            var FinalNewDeductAmt = (Number(totalrequestAMT) * Number(Deductt)).toFixed(2);
                            $tr.find("TD").eq(8).text(totalrequestAMT);
                            $tr.find("TD").eq(10).text(FinalNewDeductAmt);
                        }
                    });

                    exUpdateSummaryFromSelected();
                }
            }
        );
    }

    $(document).ready(function () {

        exHideLoading();
        exShowLoading();

        // Date filter for this table only
        $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
            if (!settings.nTable || settings.nTable.id !== 'tblApprovals') return true;

            var toDate = $('#toDate').val();
            var fromDate = $('#fromDate').val();
            var formatedToDate = toDate ? new Date(toDate) : null;
            var formatedFromDate = fromDate ? new Date(fromDate) : null;

            // Procedure Date column index = 6 (because details-control is col0)
            var dateField = data[6];
            var formatedDateField = dateField ? new Date(dateField) : null;
            if (!formatedDateField || isNaN(formatedDateField.getTime())) return true;

            if (formatedToDate && formatedFromDate) return (formatedToDate >= formatedDateField && formatedDateField >= formatedFromDate);
            if (formatedToDate && !formatedFromDate) return (formatedToDate >= formatedDateField);
            if (!formatedToDate && formatedFromDate) return (formatedDateField >= formatedFromDate);
            return true;
        });

        $.ajax({
            url: "/ClaimForm/GetChronicOrderList",
            type: "GET",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (data) {

                var table = $("#tblApprovals").DataTable({
                    data: data,
                    ordering: false,
                    paging: false,
                    scrollCollapse: true,
                    deferRender: true,
                    info: true,
                    columnDefs: [{ targets: 6, type: "date-eu" }],
                    dom: 'Bfrtip',
                    buttons: ['copy', 'csv', 'excel', 'print'],
                    columns: [
                        { className: 'details-control', orderable: false, data: null, defaultContent: '' },
                        { data: "ClaimID" },
                        { data: "ClaimFormNum" },
                        { data: "CustomerName" },
                        { data: "MemberName" },
                        { data: "CardNumber" },
                        { data: "ProcedureDate" },
                        { data: "TContractAmt" },
                        { data: "TRequestedAmt" },
                        { data: "DeductablePerc" },
                        { data: "DeductableAmt" },
                        {
                            data: null,
                            orderable: false,
                            searchable: false,
                            render: function (d, type, row, meta) {
                                var id = 'cbtest' + meta.row;
                                return '' +
                                    '<div class="checkbox-wrapper-19">' +
                                    '  <input type="checkbox" class="ex-rowcb" id="' + id + '">' +
                                    '  <label for="' + id + '" class="check-box"></label>' +
                                    '</div>';
                            }
                        }
                    ],
                    order: [[0, 'desc']]
                });

                // Expand/Collapse child rows
                $('#tblApprovals tbody').on('click', 'td.details-control', function () {
                    var tr = $(this).closest('tr');
                    var row = table.row(tr);

                    if (row.child.isShown()) {
                        row.child.hide();
                        tr.removeClass('shown');
                    } else {
                        row.child(format(row.data())).show();
                        tr.addClass('shown');
                    }
                });

                // Select all (visible rows only)
                $('#cbtestt').off('change').on('change', function () {
                    var checked = $(this).prop('checked') === true;
                    table.rows({ search: 'applied' }).every(function () {
                        $(this.node()).find('input.ex-rowcb').prop('checked', checked);
                    });
                    exUpdateSummaryFromSelected();
                });

                // Row checkbox change
                $(document).off('change', '#tblApprovals tbody input.ex-rowcb');
                $(document).on('change', '#tblApprovals tbody input.ex-rowcb', function () {
                    exUpdateSummaryFromSelected();
                });

                // Initial calc
                exUpdateSummaryFromSelected();
                exHideLoading();
            },
            error: function (ex) {
                exHideLoading();
                console.log(ex);
                if (window.Swal) Swal.fire("@T("Error","Error")", "@T("Msg_LoadFailed","Failed to load approvals list.")", "error");
            }
        });

        // Accept Chronic Approvals
        $(document).off('click', '#Send_To_Pay');
        $(document).on('click', '#Send_To_Pay', function () {

            Swal.fire({
                title: "@T("Confirm","Confirm")",
                imageUrl: "/Images/Quationimg.jpg",
                imageWidth: 550,
                imageHeight: 225,
                text: "@T("Q_Accept","Are you sure you want to accept selected chronic approvals?")",
                showCancelButton: true,
                confirmButtonText: "@T("Confirm","Confirm")",
                cancelButtonText: "@T("Cancel","Cancel")",
                cancelButtonColor: "#700c0c"
            }).then((result) => {

                if (!result.isConfirmed) return;

                exShowLoading();

                var Claims_Services = [];
                var dt = $('#tblApprovals').DataTable();

                dt.rows().every(function () {
                    var $tr = $(this.node());
                    var checked = $tr.find('input.ex-rowcb').prop('checked') === true;
                    if (checked) {
                        var d = this.data();
                        Claims_Services.push({
                            Claim_Id: d.ClaimID,
                            Deductable_Amt: d.DeductablePerc
                        });
                    }
                });

                if (Claims_Services.length === 0) {
                    exHideLoading();
                    Swal.fire("@T("Warning","Warning!")", "@T("Msg_SelectOne","Please select at least one invoice.")", "warning");
                    return;
                }

                $.ajax({
                    type: "POST",
                    url: "/ClaimForm/AcceptChronicApprovals",
                    data: JSON.stringify(Claims_Services),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (r) {
                        exHideLoading();

                        if (r == "0") {
                            Swal.fire("@T("Warning","Warning!")", "@T("Msg_SelectOne","Please select at least one invoice.")", "warning");
                        } else {
                            Swal.fire("@T("Success","Success")", "@T("Msg_Accepted","Invoices are accepted for member chronic.")", "success")
                                .then(function () {
                                    for (let i = 0; i < r.length; i++) {
                                        var ClaimID = r[i].ClaimID;
                                        window.open('@Url.Action("GenerateReport_PrintInvoice", "ClaimForm")?typeOfReport=PDF' + '&ClaimId=' + ClaimID, '_blank');
                                        if (i == r.length - 1) {
                                            window.open('@Url.Action("Chronic_Approvals", "ClaimForm")', '_self');
                                        }
                                    }
                                });
                        }
                    },
                    error: function () {
                        exHideLoading();
                        Swal.fire("@T("Error","Error")", "@T("Msg_ServerError","Server error while accepting approvals.")", "error");
                    }
                });
            });
        });

    });
</script>

@* ===== SignalR + notifications (زي القديم) ===== *@
<script type="text/javascript">
    document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
            $.connection.hub.stop();
        } else {
            $.connection.hub.start().done(function () {
                getData();
                getData1();
                getData2();
            }).fail(function (e) { });
        }
    });

    $(function () {
        var cus = $.connection.cusHub;

        cus.client.displayCustomer = function () { getData(); };
        cus.client.data = function () { getData1(); };
        cus.client.data1 = function () { getData2(); };

        $.connection.hub.start();
        getData();
        getData1();
        getData2();
    });

    function getData1() {
        try {
            $.ajax({
                url: $("#Getmessages").val(),
                type: 'GET',
                datatype: 'json',
                success: function () {
                    $.get("/ClaimForm/getcountmessage", {}, function (data) {
                        setBadgeCount('MesaageCount', data);
                    });
                }
            });
        } catch (err) { }
    }

    function getData() {
        try {
            $.ajax({
                url: $("#Get").val(),
                type: 'GET',
                datatype: 'json',
                success: function (data) {

                    var provid = 0;
                    var branchid = 0;
                    if ("@Session["providerid"]" != "" && "@Session["BranchID"]" != "") {
                        provid = parseInt("@Session["providerid"]");
                        branchid = parseInt("@Session["BranchID"]");
                    }
                    var ApprovePage = 0;
                    if ("@Session["ClaimForm_Approved"]" != "") {
                        ApprovePage = parseInt("@Session["ClaimForm_Approved"]");
                    }

                    $.get("/ClaimForm/getcountallert", {}, function (data1) {
                        setBadgeCount('NotifactionCount', data1);
                    });

                    $.each(data.listCus, function (i, model) {
                        if ((provid == model.ProviderID) && (branchid == model.BranchID) && (model.CardNumber != "0") && (model.ClaimFormNum != 0) && ($('#trigger').val() == "0") && (ApprovePage == 1)) {
                            $('#trigger').val("1");

                            $.connection.hub.disconnected(function () {
                                setTimeout(function () { $.connection.hub.start(); }, 5000);
                            });

                            $.get("/ClaimForm/DeactiveAlert", {}, function (data2) {
                                if ("@Session["ClaimForm_Approved"]" != "") {
                                    var ClaimForm_Approv = parseInt("@Session["ClaimForm_Approved"]");
                                    if (ClaimForm_Approv == 1) {
                                        var sound = new Audio('/Media/alert.mp3');
                                        sound.autoplay = true;
                                        sound.muted = false;
                                        sound.play();
                                        setTimeout(function () {
                                            if (window.snackbar) snackbar.classList.add('isShown');
                                            $('#CardNumbersnackbar').text(model.CardNumber);
                                            $('#Claimformsnackbar').text(model.ClaimFormNum);
                                            if (window.hideSnackbar) setTimeout(hideSnackbar, 5000);

                                            $('#trigger').val("0");
                                            setBadgeCount('NotifactionCount', data2);
                                        }, 100);
                                    }
                                }
                            });
                        }
                    });
                }
            });
        } catch (err) { }
    }

    function getData2() {
        try {
            $.ajax({
                url: $("#Get1").val(),
                type: 'GET',
                datatype: 'json',
                success: function (data) {

                    $.get("/ClaimForm/getcountallertSmartCard", {}, function (data1) {
                        setBadgeCount('MemberSmartCardRequestsCount', data1);
                    });

                    var provid = 0, branchid = 0;
                    if ("@Session["providerid"]" != "" && "@Session["BranchID"]" != "") {
                        provid = parseInt("@Session["providerid"]");
                        branchid = parseInt("@Session["BranchID"]");
                    }
                    var ApprovePage = 0, ApprovePage1 = 0, ApprovePage2 = 0;
                    if ("@Session["ClaimForm_Approved"]" != "" || "@Session["Approval"]" != "" || "@Session["Doctor_ClaimForm"]" != "") {
                        ApprovePage = parseInt("@Session["ClaimForm_Approved"]");
                        ApprovePage1 = parseInt("@Session["Approval"]");
                        ApprovePage2 = parseInt("@Session["Doctor_ClaimForm"]");
                    }

                    $.each(data.listCus, function (i, model) {
                        if ((provid == model.ProviderID) && (branchid == model.BranchID) && (model.CardNumber != "0") && ($('#trigger1').val() == "0") && (ApprovePage == 1 || ApprovePage1 == 1 || ApprovePage2 == 1)) {
                            $('#trigger1').val("1");

                            $.connection.hub.disconnected(function () {
                                setTimeout(function () { $.connection.hub.start(); }, 5000);
                            });

                            $.get("/ClaimForm/DeactiveAlertSmartCard", {}, function (data2) {
                                var sound = new Audio('/Media/alert.mp3');
                                sound.play();
                                setTimeout(function () {
                                    if (window.snackbarMember) snackbarMember.classList.add('isShown');
                                    $('#CardNumbersnackbarMember').text(model.CardNumber);
                                    if (window.hideSnackbard1) setTimeout(hideSnackbard1, 5000);

                                    $('#trigger1').val("0");
                                    setBadgeCount('MemberSmartCardRequestsCount', data2);
                                }, 100);
                            });
                        }
                    });
                }
            });
        } catch (err) { }
    }
</script>

<script>
    function refresh() {
        $.ajax({
            type: "POST",
            url: "/ClaimForm/CheckIfSessionValid",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (r) {
                if (r == "False") window.open('@Url.Action("login", "ClaimForm")', '_self');
                else setTimeout(refresh, 5000);
            }
        });
    }
    setTimeout(refresh, 1000);
</script>